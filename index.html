<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUEST of DUALISM -é‹å‘½ã®äºŒæŠã¨13ã®è©¦ç·´-</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        :root {
            --bg-color: #000000;
            --text-main: #ffffff;
            --border-color: #ffffff;
            --accent-red: #ff4444;   /* Damage/Fail */
            --accent-blue: #4488ff;  /* Magic/Effect */
            --accent-yellow: #ffeb3b; /* Gold/Item */
            --accent-green: #4caf50; /* HP/Success */
            --accent-metal: #e0e0e0; /* Metal Slime */
            --font-main: 'DotGothic16', sans-serif;
            --window-border: 2px solid #ffffff;
            --window-radius: 4px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            overflow: hidden;
            height: 100dvh; /* ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– */
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s;
        }
        
        /* True Demon Mode Body Style */
        body.true-demon-mode {
            background: radial-gradient(circle, #200 0%, #000 90%);
            animation: bg-pulse 2s infinite;
        }
        @keyframes bg-pulse {
            0% { box-shadow: inset 0 0 0 #000; }
            50% { box-shadow: inset 0 0 50px #500; }
            100% { box-shadow: inset 0 0 0 #000; }
        }

        /* Layout Structure */
        #app-container {
            display: flex;
            flex-direction: column; 
            width: 100%;
            max-width: 800px;
            height: 100%; 
            background: var(--bg-color);
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        
        /* Container in True Demon Mode */
        .true-demon-mode #app-container {
            border-color: var(--accent-red);
            box-shadow: 0 0 20px var(--accent-red);
        }
        
        @media (min-width: 769px) {
            #app-container {
                flex-direction: row;
                width: 95%;
                height: 90vh;
                border: var(--window-border);
                border-radius: var(--window-radius);
            }
        }

        /* Sidebar (Log) */
        #sidebar {
            width: 100%;
            height: 150px;
            background: #000;
            display: flex;
            flex-direction: column;
            border-top: var(--window-border);
            order: 2; /* Bottom on mobile */
            font-size: 0.9rem;
            flex-shrink: 0; /* ã‚µã‚¤ã‚ºå›ºå®š */
        }
        
        @media (min-width: 769px) {
            #sidebar {
                width: 300px;
                height: 100%;
                border-top: none;
                border-right: var(--window-border);
                order: 1; /* Left on PC */
            }
        }

        .sidebar-header {
            padding: 5px 10px;
            background: #000;
            border-bottom: var(--window-border);
            color: #fff;
            font-size: 1rem;
            text-align: center;
        }

        #log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column-reverse; 
            scrollbar-width: none;
        }

        .log-entry {
            padding: 2px 0;
            display: flex;
            align-items: center;
            line-height: 1.4;
        }
        .log-entry.fail { color: var(--accent-red); }
        .log-entry.success { color: var(--accent-blue); }
        .log-entry.item { color: var(--accent-yellow); }
        .log-entry.levelup { color: var(--accent-green); }
        .log-entry.system { color: #888; }
        .log-entry.true-boss { color: #f0f; font-weight: bold; text-shadow: 0 0 5px #f00; }
        .log-entry.metal { color: var(--accent-metal); font-weight: bold; text-shadow: 0 0 5px #fff; }

        /* Main Game Area */
        #game-area {
            flex: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px; /* ä½™ç™½ã‚’å°‘ã—æ¸›ã‚‰ã™ */
            position: relative;
            order: 1; 
            width: 100%;
            overflow-y: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå¤šã„å ´åˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }
        
        @media (min-width: 769px) {
            #game-area { order: 2; padding: 20px; overflow-y: hidden; }
        }

        /* Top Controls (ä¿®æ­£: ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦é…ç½®) */
        .top-controls {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            /* border-bottom: 1px dashed #333; å¿…è¦ãªã‚‰ç·šã‚’å…¥ã‚Œã‚‹ */
        }

        .highscore-display { 
            font-size: 0.8rem; color: var(--accent-yellow); 
            background: #000; padding: 0 5px;
            margin-right: auto; /* å·¦å¯„ã›ã«ã™ã‚‹ */
        }
        
        .ctrl-btn {
            background: transparent;
            border: 1px solid #555;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            height: 32px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚µã‚¤ã‚ºã«æ‹¡å¤§ */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            border-radius: 4px;
            font-family: var(--font-main);
            min-width: 40px;
        }
        .ctrl-btn:hover { border-color: #fff; }
        
        .auto-btn.active {
            background: var(--accent-blue);
            color: #000;
            border-color: var(--accent-blue);
            animation: pulse 1s infinite;
        }
        
        .visual-toggle { font-weight: bold; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Status Bar */
        .status-container {
            width: 100%;
            border: var(--window-border);
            border-radius: var(--window-radius);
            padding: 10px;
            margin-bottom: 10px;
            background: #000;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
        }

        .status-row {
            display: flex;
            gap: 10px;
            width: 100%;
            font-size: 1rem;
            justify-content: space-between; /* å‡ç­‰é…ç½® */
        }
        .status-row.secondary {
            font-size: 0.8rem;
            color: #ccc;
            border-top: 1px dashed #555;
            padding-top: 5px;
        }

        .stat-item { display: flex; gap: 5px; align-items: baseline; }
        .stat-label { color: #aaa; font-size: 0.8em; }
        .stat-val { color: #fff; font-weight: bold; }
        .stat-val.floor { color: var(--accent-yellow); font-size: 1.2em; }
        .stat-val.hp { color: var(--accent-green); }
        .stat-val.mp { color: var(--accent-blue); }

        /* Monster Area */
        #monster-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
            min-height: 120px; /* ã‚¹ãƒãƒ›ã§ç¸¦é•·ã«ãªã‚Šã™ããªã„ã‚ˆã†èª¿æ•´ */
        }

        #monster-visual {
            width: 160px; /* å°‘ã—å°ã•ãã—ã¦ç”»é¢åã¾ã‚Šã‚’è‰¯ãã™ã‚‹ */
            height: 160px;
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #monster-visual img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated; 
        }
        
        /* True Demon Glitch Effect */
        .true-demon-visual {
            animation: glitch-anim 0.2s infinite;
            filter: drop-shadow(0 0 10px #f0f) drop-shadow(2px 2px #f00);
        }
        @keyframes glitch-anim {
            0% { transform: translate(0) scale(1); }
            20% { transform: translate(-2px, 2px) scale(1.02); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px) scale(0.98); }
            100% { transform: translate(0) scale(1); }
        }
        
        /* Metal Slime Shine */
        .metal-visual {
            filter: drop-shadow(0 0 5px #fff) brightness(1.2);
            animation: metal-shine 2s infinite linear;
        }
        @keyframes metal-shine {
            0% { filter: drop-shadow(0 0 5px #fff) brightness(1.2) hue-rotate(0deg); }
            100% { filter: drop-shadow(0 0 5px #fff) brightness(1.2) hue-rotate(360deg); }
        }

        /* Animation Classes */
        .anim-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .anim-attack { animation: attack 0.2s forwards; }
        .anim-damage { animation: flashRed 0.5s; }
        .anim-levelup { animation: flashGreen 0.5s; }
        .anim-clear { animation: spinAndScale 1.5s forwards; }
        .anim-true-clear { animation: trueClearAnim 3s forwards; }
        .anim-talk { animation: talkBounce 0.5s ease-in-out; }

        @keyframes shake { 10%, 90% { transform: translate3d(-4px, 0, 0); } 20%, 80% { transform: translate3d(6px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }
        @keyframes attack { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        @keyframes flashRed { 0%, 100% { filter: none; } 50% { filter: drop-shadow(0 0 10px red) sepia(100%) hue-rotate(-50deg) saturate(600%); } }
        @keyframes flashGreen { 0%, 100% { filter: none; } 50% { filter: drop-shadow(0 0 10px #4caf50) brightness(1.5); } }
        @keyframes spinAndScale { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.2) rotate(180deg); opacity: 1; filter: invert(1); } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }
        @keyframes trueClearAnim { 
            0% { transform: scale(1); filter: brightness(1); } 
            20% { transform: scale(1.5); filter: brightness(10) hue-rotate(90deg); } 
            100% { transform: scale(0); filter: brightness(0); opacity: 0; } 
        }
        @keyframes talkBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Message Window (Question) */
        #message-window {
            width: 100%;
            min-height: 60px;
            border: var(--window-border);
            border-radius: var(--window-radius);
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.4;
            background: #000;
            display: flex;
            align-items: center; /* ç¸¦ä¸­å¤®æƒãˆ */
        }
        
        .true-demon-mode #message-window {
            border-color: var(--accent-red);
            color: #fdd;
        }

        /* Command Window */
        .command-window {
            width: 100%;
            display: flex;
            justify-content: flex-end; 
        }

        .choices-container {
            border: var(--window-border);
            border-radius: var(--window-radius);
            padding: 10px 20px;
            width: 140px;
            background: #000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-family: var(--font-main);
            font-size: 1.2rem;
            text-align: left;
            cursor: pointer;
            padding: 5px;
            position: relative;
            width: 100%; /* ã‚¿ãƒƒãƒ—é ˜åŸŸç¢ºä¿ */
        }
        .choice-btn:disabled { color: #555; pointer-events: none; }

        .choice-btn:hover::before, .choice-btn:active::before {
            content: "â–¶";
            position: absolute;
            left: -15px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0; } }

        /* Game Over / Clear Overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95); /* å°‘ã—é€éã•ã›ã¦èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã‚ˆã†ã« */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }
        #overlay.active { opacity: 1; pointer-events: auto; }
        
        #overlay.clear-mode {
            background: linear-gradient(135deg, #000 0%, #1a1a00 100%);
            border: 4px double var(--accent-yellow);
        }
        #overlay.clear-mode .game-over-title {
            color: var(--accent-yellow);
            border-bottom-color: var(--accent-yellow);
            text-shadow: 0 0 10px var(--accent-yellow);
            font-size: 2.5rem;
        }
        
        #overlay.true-clear-mode {
            background: linear-gradient(135deg, #200 0%, #000 100%);
            border: 4px double #f0f;
        }
        #overlay.true-clear-mode .game-over-title {
            color: #f0f;
            border-bottom-color: #f0f;
            text-shadow: 0 0 20px #f0f;
            font-size: 3rem;
        }

        .game-over-title { 
            font-size: 2rem; 
            color: var(--accent-red); 
            margin: 20px 0 10px 0;
            border-bottom: 2px solid var(--accent-red);
        }
        
        .king-message {
            color: var(--accent-red);
            font-size: 1rem;
            margin-bottom: 15px;
            font-family: var(--font-main);
        }

        .result-container {
            border: var(--window-border);
            padding: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
            text-align: left;
            background: #000;
        }
        
        .result-header { font-size: 1.1rem; border-bottom: 1px dashed #fff; margin-bottom: 10px; padding-bottom: 5px;}
        .result-stats { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; color: #ccc;}
        
        .loot-list {
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 5px;
            font-size: 0.9rem;
            scrollbar-width: thin;
            margin-bottom: 15px;
        }
        .loot-item { margin-bottom: 2px; color: var(--accent-yellow); }
        
        .new-record {
            color: var(--accent-yellow);
            font-weight: bold;
            animation: blink 1s infinite;
            display: none; 
            margin-left: 10px;
        }

        .record-stats-area {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 8px;
        }
        .stats-row:last-child { margin-bottom: 0; }

        .record-stat-box { text-align: center; min-width: 70px; }
        .record-stat-num { color: #fff; font-size: 1.1rem; display: block; }
        .record-stat-label { font-size: 0.7rem; display: block; }

        .alias-val { font-size: 1.3rem; color: #fff; font-weight: bold; text-align: center; margin: 10px 0;}

        .restart-btn {
            margin: 10px 0;
            padding: 10px 30px;
            background: transparent;
            border: var(--window-border);
            color: #fff;
            font-family: var(--font-main);
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%; /* ã‚¹ãƒãƒ›ã§æŠ¼ã—ã‚„ã™ã */
            max-width: 300px;
        }
        .restart-btn:hover { background: #fff; color: #000; }
        
        .delete-btn {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #555;
            background: transparent;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            padding: 10px; /* ã‚¿ãƒƒãƒ—é ˜åŸŸç¢ºä¿ */
        }
        .delete-btn:hover { color: var(--accent-red); }

        /* Bestiary & Help Overlay */
        .overlay-window {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 60;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        .overlay-window.active { display: flex; }

        .bestiary-header, .help-header {
            font-size: 1.5rem; color: #fff; text-align: center; margin-bottom: 10px;
            border-bottom: 2px solid #fff; padding-bottom: 5px;
        }
        
        .bestiary-tabs { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .tab-btn {
            background: #000; border: 1px solid #555; color: #aaa; padding: 5px 15px; cursor: pointer;
        }
        .tab-btn.active { border-color: #fff; color: #fff; background: #222; }

        .bestiary-content, .help-content {
            flex: 1; overflow-y: auto; border: 1px solid #333; padding: 10px;
            font-size: 0.9rem; scrollbar-width: thin;
        }
        
        .collection-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .collection-item {
            padding: 3px 8px; border: 1px solid #333; color: #888;
        }
        .collection-item.unlocked { color: var(--accent-yellow); border-color: var(--accent-yellow); }
        .collection-item.alias-item { color: #aaa; border-color: #444; width: 100%; }
        .collection-item.alias-item.unlocked { color: var(--accent-blue); border-color: var(--accent-blue); }

        .close-btn {
            margin-top: 10px; padding: 10px; border: 1px solid #fff; background: #000; color: #fff; cursor: pointer;
        }

        /* Help Content Styles */
        .help-section { margin-bottom: 20px; }
        .help-title { color: var(--accent-yellow); border-bottom: 1px dashed #555; margin-bottom: 5px; }
        .help-item { display: flex; margin-bottom: 8px; }
        .help-icon { width: 40px; text-align: center; font-weight: bold; }
        .help-desc { flex: 1; color: #ccc; }

        svg { width: 100%; height: 100%; }
        .pixel-art rect { shape-rendering: crispEdges; }

    </style>
</head>
<body>

    <div id="app-container">
        <!-- Main Game Area -->
        <section id="game-area">
            <!-- ä¿®æ­£: ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦é…ç½®ã—ã€çµ¶å¯¾é…ç½®ã‚’å»ƒæ­¢ã€‚Flexã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç† -->
            <div class="top-controls">
                <div class="highscore-display">HI-SCORE: <span id="hs-val-sm">B0F</span></div>
                <button class="ctrl-btn" onclick="openHelp()" title="ãƒ˜ãƒ«ãƒ—">ï¼Ÿ</button>
                <button class="ctrl-btn" onclick="openBestiary()" title="å›³é‘‘ã‚’è¦‹ã‚‹">ğŸ“–</button>
                <button class="ctrl-btn visual-toggle" onclick="toggleVisualMode()" id="visual-btn" title="ç”»è³ªåˆ‡æ›¿">IMG</button>
                <button class="ctrl-btn auto-btn" onclick="toggleAutoMode()" id="auto-btn">AUTO OFF</button>
                <button class="ctrl-btn sound-toggle" onclick="SoundManager.toggleMute()" title="ã‚µã‚¦ãƒ³ãƒ‰ON/OFF">ğŸ”Š</button>
            </div>
            
            <!-- Status -->
            <div class="status-container">
                <div class="status-row">
                    <div class="stat-item"><span class="stat-label">FLOOR</span><span class="stat-val floor" id="floor-val">B1F</span></div>
                    <div class="stat-item"><span class="stat-label">LV</span><span class="stat-val" id="level-val">1</span></div>
                    <div class="stat-item"><span class="stat-label">HP</span><span class="stat-val hp" id="hp-val">20</span></div>
                </div>
                <div class="status-row secondary">
                    <div class="stat-item"><span class="stat-label">MP</span><span class="stat-val mp" id="mp-val">5</span></div>
                    <div class="stat-item"><span class="stat-label">ã“ã†ã’ã</span><span class="stat-val" id="atk-val">10</span></div>
                    <div class="stat-item" style="margin-left:auto; font-size:0.8rem;"><span class="stat-label">ç¢ºç‡:</span> 1/<span id="prob-val">2</span></div>
                </div>
            </div>

            <!-- Monster -->
            <div id="monster-container">
                <div id="monster-visual">
                    <!-- Monster will be injected here -->
                </div>
            </div>

            <!-- Message -->
            <div id="message-window">
                ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼
            </div>

            <!-- Command -->
            <div class="command-window">
                <div class="choices-container">
                    <button class="choice-btn" id="btn-yes" onclick="makeChoice('left')">ã¯ã„</button>
                    <button class="choice-btn" id="btn-no" onclick="makeChoice('right')">ã„ã„ãˆ</button>
                </div>
            </div>
        </section>

        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">ã¼ã†ã‘ã‚“ã® ãã‚ã</div>
            <div id="log-container">
                <!-- Logs will be inserted here -->
            </div>
        </aside>

        <!-- Game Over Overlay -->
        <div id="overlay">
            <div class="game-over-title" id="overlay-title">å…¨æ»…ã—ãŸ...</div>
            
            <div id="king-msg" class="king-message"></div>
            
            <div class="result-container">
                <div class="result-header">ç§°å·: <span id="alias-val">åã‚‚ãªãæ‘äºº</span></div>
                
                <div id="new-record-badge" class="new-record">â˜… NEW RECORD! â˜…</div>

                <div style="text-align:center; font-size:0.9rem; color:#888; margin-bottom:10px;">
                    æ­£è§£ã¯ã€Œ<span id="true-fate-display"></span>ã€ã§ã—ãŸ
                </div>

                <div class="result-header">æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div class="result-stats">
                    <span>åˆ°é”: <span id="res-floor">B1F</span></span>
                    <span>LV: <span id="res-lvl">1</span></span>
                    <span>HP: <span id="res-hp">0</span></span>
                    <span>MP: <span id="res-mp">0</span></span>
                    <span>æ”»: <span id="res-atk">0</span></span>
                </div>

                <div class="result-header">ç²å¾—ã‚¢ã‚¤ãƒ†ãƒ </div>
                <div class="loot-list" id="loot-list">
                    <!-- Items -->
                </div>
                
                <!-- Adventure Records -->
                <div class="record-stats-area">
                    <!-- Row 1: Play Counts -->
                    <div class="stats-row">
                        <div class="record-stat-box">
                            <span class="record-stat-label">å†’é™ºå›æ•°</span>
                            <span class="record-stat-num" id="stat-attempts">0</span>
                        </div>
                        <div class="record-stat-box">
                            <span class="record-stat-label">ã‚¯ãƒªã‚¢å›æ•°</span>
                            <span class="record-stat-num" id="stat-clears">0</span>
                        </div>
                    </div>
                    
                    <!-- Row 2: Choices & Rate -->
                    <div class="stats-row">
                        <div class="record-stat-box">
                            <span class="record-stat-label">ç·é¸æŠæ•°</span>
                            <span class="record-stat-num" id="stat-choices">0</span>
                        </div>
                        <div class="record-stat-box">
                            <span class="record-stat-label">é‹å‘½çš„ä¸­ç‡</span>
                            <span class="record-stat-num" id="stat-rate">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="restart-btn" onclick="openBestiary()">ğŸ“– å›³é‘‘ã‚’è¦‹ã‚‹</button>
            <button class="restart-btn" onclick="resetGame()">ã•ã„ã—ã‚‡ã‹ã‚‰</button>
            <br>
            <button class="delete-btn" onclick="clearData()">ãã‚ãã‚’ ã¾ã£ã—ã‚‡ã† ã™ã‚‹</button>
        </div>

        <!-- Bestiary Overlay -->
        <div id="bestiary-overlay" class="overlay-window">
            <div class="bestiary-header">å†’é™ºã®æ›¸ (å›³é‘‘)</div>
            <div class="bestiary-tabs">
                <button class="tab-btn active" onclick="switchBestiaryTab('items')">ã‚¢ã‚¤ãƒ†ãƒ </button>
                <button class="tab-btn" onclick="switchBestiaryTab('aliases')">ç§°å·</button>
            </div>
            <div style="text-align:right; font-size:0.8rem; margin-bottom:5px; color:#aaa;">
                åé›†ç‡: <span id="collection-rate">0%</span>
            </div>
            <div id="bestiary-content" class="bestiary-content">
                <!-- Content injected by JS -->
            </div>
            <button class="close-btn" onclick="closeBestiary()">é–‰ã˜ã‚‹</button>
        </div>
        
        <!-- Help Overlay -->
        <div id="help-overlay" class="overlay-window">
            <div class="help-header">ã‚ãã³ã‹ãŸ</div>
            <div class="help-content">
                <div class="help-section">
                    <div class="help-title">ãƒ«ãƒ¼ãƒ«</div>
                    <p style="color:#ddd; line-height:1.6;">
                        é‹å‘½ã®äºŒæŠã‚’é¸ã³ã€13ã®è©¦ç·´ã‚’çªç ´ã›ã‚ˆã€‚<br>
                        æ­£è§£ãªã‚‰ã°å…ˆã¸é€²ã¿ã€å¼·ããªã‚‹ã€‚<br>
                        ä¸æ­£è§£ãªã‚‰ã°å³æ­»ã€‚<br>
                        æœ€æ·±éƒ¨ã®é­”ç‹ã‚’å€’ã™ã“ã¨ãŒç›®çš„ã ã€‚<br>
                        <span style="color:#aaa; font-size:0.8em;">â€»ä½ç¢ºç‡ã§ã€ŒçœŸã®é­”ç‹ã€ãŒç¾ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã‚‰ã—ã„â€¦ï¼Ÿ</span>
                    </p>
                </div>
                <div class="help-section">
                    <div class="help-title">ãƒœã‚¿ãƒ³ã›ã¤ã‚ã„</div>
                    <div class="help-item">
                        <div class="help-icon">IMG</div>
                        <div class="help-desc">ãƒ‰ãƒƒãƒˆçµµ(DOT)ã¨ç”»åƒãƒ¢ãƒ¼ãƒ‰(IMG)ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚ç”»åƒãŒãªã„å ´åˆã¯ãƒ‰ãƒƒãƒˆçµµãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚</div>
                    </div>
                    <div class="help-item">
                        <div class="help-icon">AUTO</div>
                        <div class="help-desc">è‡ªå‹•ã§é¸æŠè‚¢ã‚’é¸ã‚“ã§é€²ã‚€ãƒ¢ãƒ¼ãƒ‰ã€‚ãƒã‚¤ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã‚„æœ€çµ‚æˆ¦ã§ã¯è‡ªå‹•åœæ­¢ã™ã‚‹ã€‚</div>
                    </div>
                    <div class="help-item">
                        <div class="help-icon">ğŸ“–</div>
                        <div class="help-desc">ç²å¾—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚„ç§°å·ã®å›³é‘‘ã‚’è¦‹ã‚‹ã€‚</div>
                    </div>
                    <div class="help-item">
                        <div class="help-icon">ğŸ”Š</div>
                        <div class="help-desc">ã‚µã‚¦ãƒ³ãƒ‰ã®ON/OFFã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚</div>
                    </div>
                </div>
            </div>
            <button class="close-btn" onclick="closeHelp()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        /**
         * QUEST of DUALISM - Ver 16.0 (Ending Messages)
         */

        // Game State
        let currentFloor = 0; // éšå±¤ (B1F...) ãƒã‚¤ã‚¹ã‚³ã‚¢å¯¾è±¡
        let playerLevel = 1;  // å¼·ã•
        let bestRecord = { floor: 0, items: [], alias: "ãªã—" }; // Changed level to floor
        let statsRecord = { 
            totalAttempts: 0, totalClears: 0, trueClears: 0, totalChoices: 0, totalSuccesses: 0,
            collectedItems: [], collectedAliases: [] 
        }; 
        let gameSettings = { isPixelMode: true }; 
        
        let predeterminedFate = null; 
        let choiceStats = { yes: 0, no: 0 };
        let currentMonster = null;
        let isGameClear = false;
        let isTrueClear = false;
        let isProcessing = false;
        
        // Auto Mode
        let isAutoMode = false;
        let autoTimeout = null;
        
        // Player Stats
        let playerStats = {
            hp: 20, maxHp: 20,
            mp: 5, maxMp: 5,
            atk: 10,
            items: []
        };

        // --- Sound Manager ---
        const SoundManager = {
            ctx: null,
            muted: false,
            init: function() {
                if (!this.ctx) {
                    try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
                }
                if (this.ctx && this.ctx.state === 'suspended') { this.ctx.resume(); }
            },
            toggleMute: function() {
                this.muted = !this.muted;
                const btn = document.querySelector('.sound-toggle');
                btn.innerText = this.muted ? "ğŸ”‡" : "ğŸ”Š";
                if(!this.muted) this.init();
            },
            playTone: function(freq, type, duration, startTime = 0, vol = 0.1) {
                if (this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + startTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + startTime);
                osc.stop(this.ctx.currentTime + startTime + duration);
            },
            playNoise: function(duration, vol = 0.1) {
                if (this.muted || !this.ctx) return;
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                noise.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },
            playAttack: function() { this.init(); this.playNoise(0.1, 0.2); this.playTone(100, 'square', 0.1, 0, 0.1); },
            playDamage: function() { this.init(); this.playTone(150, 'sawtooth', 0.3, 0, 0.2); this.playTone(100, 'sawtooth', 0.3, 0.1, 0.2); },
            playLevelUp: function() { this.init(); const t = 0.08; this.playTone(523.25, 'square', 0.2, 0); this.playTone(659.25, 'square', 0.2, t); this.playTone(783.99, 'square', 0.2, t*2); this.playTone(1046.50, 'square', 0.4, t*3); },
            playClear: function() { this.init(); const t = 0.12; const v = 0.15; const notes = [523.25, 659.25, 783.99, 1046.50, 0, 783.99, 1046.50]; notes.forEach((freq, i) => { if(freq > 0) this.playTone(freq, 'square', 0.3, i * t, v); }); },
            playGameOver: function() { this.init(); this.playTone(300, 'triangle', 0.5, 0, 0.2); this.playTone(250, 'triangle', 0.5, 0.4, 0.2); this.playTone(200, 'triangle', 1.0, 0.8, 0.2); },
            playTrueClear: function() { 
                this.init(); 
                const base = 220; 
                for(let i=0; i<30; i++) {
                    const freq = base * (1 + Math.random()*4);
                    this.playTone(freq, 'sawtooth', 0.1, i*0.05, 0.1);
                }
            }
        };

        // --- Data Lists ---
        const weaponNames = [
            "ã²ã®ãã®ã¼ã†", "ã“ã‚“ã¼ã†", "ã©ã†ã®ã¤ã‚‹ã", "ã¦ã¤ã®ã‚„ã‚Š", 
            "ã¯ãŒã­ã®ã¤ã‚‹ã", "ã¾ã©ã†ã—ã®ã¤ãˆ", "ãƒ‘ãƒ«ãƒã‚¶ãƒ³", "ã¯ã˜ã‚ƒã®ã¤ã‚‹ã", 
            "ã»ã®ãŠã®ã¤ã‚‹ã", "ã“ãŠã‚Šã®ã‚„ã„ã°", "ãƒ‰ãƒ©ã‚´ãƒ³ã‚­ãƒ©ãƒ¼", "ã‚ãã¾ã®ã‚ªãƒ",
            "ã‚‰ã„ã˜ã‚“ã®ã‘ã‚“", "ã²ã‹ã‚Šã®ã¤ã‚‹ã", "ã‚†ã†ã—ã‚ƒã®ã¤ã‚‹ã", "ã§ã‚“ã›ã¤ã®ã¶ã",
            "ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼", "ãƒ©ã‚°ãƒŠãƒ­ã‚¯", "ã‚°ãƒ³ã‚°ãƒ‹ãƒ«", "ãƒ ãƒ©ãƒã‚µ", 
            "ãƒ­ãƒ³ã‚®ãƒŒã‚¹", "ã‚²ã‚¤ãƒœãƒ«ã‚°", "ã‚¯ã‚µãƒŠã‚®", "ç«¹æ§", "ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³", 
            "ãƒãƒªã‚»ãƒ³", "ãƒ”ã‚³ãƒ”ã‚³ãƒãƒ³ãƒãƒ¼", "ãƒ“ãƒ¼ãƒ ã‚µãƒ¼ãƒ™ãƒ«", "ã­ã", "ã‚¤ãƒ¼ã‚¸ã‚¹ã®ãŸã¦",
            "éŒ†ã³ãŸçŸ­å‰£", "ã‚¬ãƒ©ã‚¹ã®å‰£", "ãƒœãƒ¼ãƒ³ã‚¯ãƒ©ãƒ–", "ãƒŸã‚¹ãƒªãƒ«ã‚½ãƒ¼ãƒ‰", "ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ãƒ€ã‚¬ãƒ¼", "é­”å‰£ã‚°ãƒ©ãƒ ", "è–å‰£ãƒ‡ãƒ¥ãƒ©ãƒ³ãƒ€ãƒ«", "ç¥æ§ãƒ–ãƒªãƒ¥ãƒ¼ãƒŠã‚¯", "æ–¹å¤©ç”»æˆŸ", "é’é¾åˆ€",
            "ãƒŒãƒ³ãƒãƒ£ã‚¯", "ãƒ–ãƒ¼ãƒ¡ãƒ©ãƒ³", "ãƒ¨ãƒ¼ãƒ¨ãƒ¼", "ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰", "æ°´æ™¶ç‰", "è¾æ›¸", "å®šè¦", "ãƒ¢ãƒƒãƒ—", "ãƒã‚§ãƒ¼ãƒ³ã‚½ãƒ¼", "å†·å‡ãƒã‚°ãƒ­",
            "å…‰ç·šéŠƒ", "ãƒ­ã‚±ãƒƒãƒˆãƒ©ãƒ³ãƒãƒ£ãƒ¼", "æ‰‹æ¦´å¼¾", "ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼", "ãƒãƒˆãƒ«ã‚¢ãƒƒã‚¯ã‚¹", "ã‚¦ã‚©ãƒ¼ãƒãƒ³ãƒãƒ¼", "ãƒ©ãƒ³ã‚¹", "ãƒãƒ«ãƒãƒ¼ãƒ‰", "ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆ", "ã‚¯ãƒ­ã‚¹ãƒœã‚¦",
            "ã‚·ãƒ§ãƒ¼ãƒˆãƒœã‚¦", "ãƒ­ãƒ³ã‚°ãƒœã‚¦", "ã‚¢ãƒ¼ãƒãƒ¬ã‚¹ãƒˆ", "ããªã„", "æ‰‹è£å‰£", "ã¾ãã³ã—", "å¿è€…åˆ€", "ããªã„", "åæ‰‹", "é–éŒ",
            "ãƒãƒ¼ãƒ«ã®ã‚ˆã†ãªã‚‚ã®", "é‡‘å±ãƒãƒƒãƒˆ", "ã‚¹ã‚³ãƒƒãƒ—", "ãƒ„ãƒ«ãƒã‚·", "ãƒã‚³ã‚®ãƒª", "ã‹ãªã¥ã¡", "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼", "ã‚¹ãƒ‘ãƒŠ", "ãƒ‘ã‚¤ãƒ—ãƒ¬ãƒ³ãƒ", "ãƒ‰ãƒªãƒ«",
            "ã‚®ã‚¿ãƒ¼", "ãƒã‚¤ã‚¯", "ãƒ‰ãƒ©ãƒ ã‚¹ãƒ†ã‚£ãƒƒã‚¯", "æŒ‡æ®æ£’", "ç­†", "ä¸‡å¹´ç­†", "ãã‚ã°ã‚“", "é›»å“", "ã‚¹ãƒãƒ›", "ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ",
            "ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«", "ãƒ¬ãƒ¼ãƒ´ã‚¡ãƒ†ã‚¤ãƒ³", "ã‚¢ãƒ­ãƒ³ãƒ€ã‚¤ãƒˆ", "ã‚«ãƒ©ãƒ‰ãƒœãƒ«ã‚°", "ãƒãƒ«ãƒ ãƒ³ã‚¯", "å¤©å¢é›²å‰£", "å¸ƒéƒ½å¾¡é­‚", "ä¸ƒæ”¯åˆ€", "å¦–åˆ€æ‘æ­£", "æ–¬é‰„å‰£",
            "å¦‚æ„æ£’", "èŠ­è•‰æ‰‡", "é‡‘ç •æ£’", "è–™åˆ€", "ããªã„ï¼ˆæ¯’ï¼‰", "ã¾ãã³ã—ï¼ˆé‰„ï¼‰", "æ‰‹è£å‰£ï¼ˆçˆ†ï¼‰", "ç«ç¸„éŠƒ", "å¤§ç ²", "æˆ¦è»Š",
            "ãƒ©ã‚¤ãƒˆã‚»ãƒ¼ãƒãƒ¼ï¼ˆèµ¤ï¼‰", "ãƒ©ã‚¤ãƒˆã‚»ãƒ¼ãƒãƒ¼ï¼ˆé’ï¼‰", "ãƒ“ãƒ¼ãƒ ãƒ©ã‚¤ãƒ•ãƒ«", "ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚ºãƒ¼ã‚«", "ãƒ‘ã‚¤ãƒ«ãƒãƒ³ã‚«ãƒ¼", "ãƒ‰ãƒªãƒ«ãƒ©ãƒ³ã‚¹", "ãƒ­ã‚±ãƒƒãƒˆãƒ‘ãƒ³ãƒ", "æœ‰ç·šå¼ã‚µã‚¤ã‚³ãƒŸãƒ¥", "ãƒ•ã‚¡ãƒ³ãƒãƒ«",
            "è–ãªã‚‹æ‰‹æ¦´å¼¾", "é»„é‡‘ã®éŠƒ", "éŠ€ã®å¼¾ä¸¸", "ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢ã‚­ãƒ©ãƒ¼", "ãƒ‰ãƒ©ã‚´ãƒ³ãƒã‚¹ã‚¿ãƒ¼", "ã‚´ãƒƒãƒ‰ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼", "ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ³ãƒ‰", "ã‚«ã‚ªã‚¹ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼", "ã‚½ã‚¦ãƒ«ã‚¨ãƒƒã‚¸", "ã‚½ã‚¦ãƒ«ã‚­ãƒ£ãƒªãƒãƒ¼",
            "å‹‡è€…ã®å‰£ï¼ˆæ¨¡é€ åˆ€ï¼‰", "ä¼èª¬ã®å‰£ï¼ˆãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ï¼‰", "ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼ï¼ˆã‚«ãƒªãƒãƒ¼ï¼‰", "ãŸã ã®æ£’", "ã‚‚ã®ã™ã”ãç¡¬ã„ãƒ‘ãƒ³", "è…ã£ãŸé­š", "ç”ŸããŸã‚¿ã‚³", "ç†±ã€…ã®ãƒ”ã‚¶",
            "è¾æ›¸ï¼ˆéˆå™¨ï¼‰", "å…­æ³•å…¨æ›¸", "ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³ï¼ˆãƒ†ãƒ•ãƒ­ãƒ³ï¼‰", "ä¸­è¯é‹", "ãŠãŸã¾", "æ³¡ç«‹ã¦å™¨", "åŒ…ä¸", "ã‚µãƒã‚¤ãƒãƒ«ãƒŠã‚¤ãƒ•", "ã‚«ãƒƒã‚¿ãƒ¼ãƒŠã‚¤ãƒ•",
            "æ•", "å¸ƒå›£ãŸãŸã", "æƒé™¤æ©Ÿ", "ã‚¢ã‚¤ãƒ­ãƒ³", "æ´—æ¿¯æ©Ÿ", "å†·è”µåº«", "é›»å­ãƒ¬ãƒ³ã‚¸", "ãƒ†ãƒ¬ãƒ“", "ãƒ‘ã‚½ã‚³ãƒ³",
            "éš•çŸ³", "ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«", "ãƒ“ãƒƒã‚°ãƒãƒ³", "è¶…æ–°æ˜Ÿ", "éŠ€æ²³", "å®‡å®™", "è™šç„¡", "å¸Œæœ›", "çµ¶æœ›", "æ„›"
        ];
        
        const itemNames = [
            "ã‚„ããã†", "ã©ãã‘ã—ãã†", "ã›ã„ã™ã„", "ã¡ã‹ã‚‰ã®ãŸã­", "ã¾ã‚‚ã‚Šã®ãŸã­", "ã™ã°ã‚„ã•ã®ãŸã­", "ã„ã®ã¡ã®ãã®ã¿", "ãµã—ããªãã®ã¿", "ã‚¨ãƒ«ãƒ•ã®ã®ã¿ãã™ã‚Š", "ã›ã‹ã„ã˜ã‚…ã®ã¯",
            "ã‘ã‚“ã˜ã‚ƒã®ã„ã—", "ã‚¨ãƒªã‚¯ã‚µãƒ¼", "ãƒ©ã‚¹ãƒˆã‚¨ãƒªã‚¯ã‚µãƒ¼", "ãŠã«ãã‚Š", "ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ", "ãƒãƒ¼ã‚·ãƒ§ãƒ³", "ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³", "ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹ã®å°¾", "ãã‚“ã®ã®ã¹ã¼ã†", "ã‚¬ãƒ©ã‚¯ã‚¿",
            "çŸ³ã“ã‚", "ç©ºãç¼¶", "ãƒœãƒ­å¸ƒ", "ãŸã ã®ç´™åˆ‡ã‚Œ", "ãƒ©ãƒ–ãƒ¬ã‚¿ãƒ¼", "å®ã®åœ°å›³", "èº«ä»£ã‚ã‚Šäººå½¢", "ç…™ç‰", "å…µç³§ä¸¸", "æ¿€è¾›ã‚«ãƒ¬ãƒ¼",
            "ã‚¹ãƒ†ãƒ¼ã‚­", "ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼", "ãƒ”ã‚¶", "å¯¿å¸", "ãƒ©ãƒ¼ãƒ¡ãƒ³", "ã†ã©ã‚“", "ãã°", "ãƒ‘ã‚¹ã‚¿", "ã‚ªãƒ ãƒ©ã‚¤ã‚¹", "ã‚°ãƒ©ã‚¿ãƒ³",
            "ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­", "ãƒ—ãƒªãƒ³", "ã‚¼ãƒªãƒ¼", "ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ", "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ", "ã‚­ãƒ£ãƒ³ãƒ‡ã‚£", "ã‚¯ãƒƒã‚­ãƒ¼", "ãƒ‰ãƒ¼ãƒŠãƒ„", "ãƒã‚«ãƒ­ãƒ³", "ã‚¿ãƒ”ã‚ªã‚«",
            "ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰", "ãƒ«ãƒ“ãƒ¼", "ã‚µãƒ•ã‚¡ã‚¤ã‚¢", "ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰", "ãƒˆãƒ‘ãƒ¼ã‚º", "ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ", "ã‚ªãƒ‘ãƒ¼ãƒ«", "ã‚¬ãƒ¼ãƒãƒƒãƒˆ", "ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³", "ãƒšãƒªãƒ‰ãƒƒãƒˆ",
            "é‰„é‰±çŸ³", "éŠ…é‰±çŸ³", "éŠ€é‰±çŸ³", "é‡‘é‰±çŸ³", "ãƒŸã‚¹ãƒªãƒ«é‰±çŸ³", "ã‚ªãƒªãƒãƒ«ã‚³ãƒ³é‰±çŸ³", "ã‚¢ãƒ€ãƒãƒ³ã‚¿ã‚¤ãƒˆ", "ãƒ€ãƒ¼ã‚¯ãƒã‚¿ãƒ¼", "è³¢è€…ã®çŸ³ã®ã‹ã‘ã‚‰", "æ˜Ÿã®ç ‚",
            "ãƒ‰ãƒ©ã‚´ãƒ³ã®é±—", "ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã®è§’", "ã‚°ãƒªãƒ•ã‚©ãƒ³ã®ç¾½", "ã‚¹ãƒ©ã‚¤ãƒ ã®ä½“æ¶²", "ã‚´ãƒ–ãƒªãƒ³ã®è…°å¸ƒ", "ã‚ªãƒ¼ã‚¯ã®ç‰™", "å¸è¡€é¬¼ã®ç°", "æ‚ªé­”ã®ã—ã£ã½", "å¤©ä½¿ã®è¼ª", "ç¥ã®æ¶™"
        ];
        
        const rareItems = [
            "ã—ã‚ã‚ã›ã®ãã¤", "ãƒ¡ã‚¿ãƒ«ã®å‰£", "å¹¸é‹ã®ã‚³ã‚¤ãƒ³", "ãƒ—ãƒ©ãƒãƒŠãƒã‚±ãƒƒãƒˆ", "ã¯ãã‚Œã®ã•ã¨ã‚Š", "ãƒ¡ã‚¿ãƒ«ã‚­ãƒ³ã‚°ã®ç›¾"
        ];

        const allItemsList = [...weaponNames, ...itemNames, ...rareItems].sort();

        const monsterDefs = {
            slime: { id: "slime", name: "ã‚¹ãƒ©ã‚¤ãƒ ", color: "#4488ff", pixels: [{x:5,y:5,w:6,h:1}, {x:3,y:6,w:10,h:1}, {x:2,y:7,w:12,h:1}, {x:1,y:8,w:14,h:4}, {x:2,y:12,w:12,h:1}, {x:4,y:9,w:1,h:1,c:"#000"}, {x:11,y:9,w:1,h:1,c:"#000"}] },
            goblin: { id: "goblin", name: "ã‚´ãƒ–ãƒªãƒ³", color: "#4caf50", pixels: [{x:4,y:3,w:8,h:5}, {x:2,y:4,w:2,h:3}, {x:12,y:4,w:2,h:3}, {x:5,y:5,w:1,h:1,c:"#000"}, {x:10,y:5,w:1,h:1,c:"#000"}, {x:6,y:7,w:4,h:1,c:"#000"}, {x:4,y:8,w:8,h:6}, {x:2,y:9,w:2,h:3}, {x:12,y:9,w:2,h:3}] },
            bat: { id: "bat", name: "ã‚³ã‚¦ãƒ¢ãƒª", color: "#aa44ff", pixels: [{x:1,y:4,w:2,h:3}, {x:3,y:6,w:1,h:2}, {x:4,y:7,w:1,h:2}, {x:5,y:8,w:1,h:1}, {x:13,y:4,w:2,h:3}, {x:12,y:6,w:1,h:2}, {x:11,y:7,w:1,h:2}, {x:10,y:8,w:1,h:1}, {x:6,y:6,w:4,h:4}, {x:7,y:7,w:1,h:1,c:"#fff"}, {x:9,y:7,w:1,h:1,c:"#fff"}] },
            wolf: { id: "wolf", name: "ã‚¦ãƒ«ãƒ•", color: "#9e9e9e", pixels: [{x:2,y:5,w:4,h:4}, {x:6,y:6,w:8,h:5}, {x:6,y:11,w:2,h:3}, {x:12,y:11,w:2,h:3}, {x:3,y:6,w:1,h:1,c:"#fff"}, {x:14,y:7,w:2,h:2}] },
            orc: { id: "orc", name: "ã‚ªãƒ¼ã‚¯", color: "#795548", pixels: [{x:4,y:2,w:8,h:6}, {x:3,y:4,w:1,h:2}, {x:12,y:4,w:1,h:2}, {x:5,y:9,w:6,h:5}, {x:5,y:5,w:1,h:1,c:"#000"}, {x:10,y:5,w:1,h:1,c:"#000"}, {x:6,y:7,w:1,h:2,c:"#fff"}, {x:9,y:7,w:1,h:2,c:"#fff"}] },
            skeleton: { id: "skeleton", name: "ã‚¬ã‚¤ã‚³ãƒ„", color: "#e0e0e0", pixels: [{x:5,y:2,w:6,h:1}, {x:4,y:3,w:8,h:1}, {x:3,y:4,w:10,h:4}, {x:5,y:5,w:2,h:2,c:"#000"}, {x:9,y:5,w:2,h:2,c:"#000"}, {x:7,y:9,w:2,h:1,c:"#000"}, {x:4,y:10,w:8,h:1}, {x:5,y:11,w:6,h:1}, {x:5,y:12,w:1,h:2}, {x:7,y:12,w:1,h:2}, {x:9,y:12,w:1,h:2}] },
            golem: { id: "golem", name: "ã‚´ãƒ¼ãƒ¬ãƒ ", color: "#c19a6b", pixels: [{x:4,y:1,w:8,h:5}, {x:5,y:3,w:1,h:1,c:"#f00"}, {x:10,y:3,w:1,h:1,c:"#f00"}, {x:2,y:6,w:12,h:6}, {x:1,y:7,w:1,h:4}, {x:14,y:7,w:1,h:4}, {x:4,y:12,w:3,h:3}, {x:9,y:12,w:3,h:3}] },
            chimera: { id: "chimera", name: "ã‚­ãƒ¡ãƒ©", color: "#e91e63", pixels: [{x:6,y:2,w:4,h:4}, {x:4,y:6,w:8,h:5}, {x:1,y:4,w:3,h:6}, {x:12,y:4,w:3,h:6}, {x:7,y:3,w:1,h:1,c:"#000"}, {x:5,y:11,w:2,h:3}, {x:9,y:11,w:2,h:3}] },
            dragon: { id: "dragon", name: "ãƒ‰ãƒ©ã‚´ãƒ³", color: "#44ff44", pixels: [{x:2,y:8,w:12,h:6}, {x:4,y:4,w:4,h:4}, {x:3,y:3,w:1,h:2}, {x:8,y:3,w:1,h:3}, {x:5,y:5,w:1,h:1,c:"#000"}, {x:0,y:7,w:3,h:3}, {x:12,y:6,w:4,h:3}, {x:3,y:10,w:10,h:3,c:"#ffffaa"}] },
            reaper: { id: "reaper", name: "ã—ã«ãŒã¿", color: "#607d8b", pixels: [{x:6,y:2,w:4,h:4}, {x:5,y:6,w:6,h:8}, {x:12,y:3,w:1,h:10,c:"#aaa"}, {x:11,y:3,w:3,h:1,c:"#aaa"}, {x:4,y:8,w:8,h:0}, {x:7,y:3,w:1,h:1,c:"#000"}, {x:8,y:3,w:1,h:1,c:"#000"}, {x:3,y:6,w:2,h:6, c:"#444"}] },
            demon: { id: "demon", name: "ã¾ãŠã†", color: "#8800ff", pixels: [{x:6,y:1,w:4,h:2}, {x:4,y:3,w:8,h:9}, {x:2,y:4,w:2,h:6}, {x:12,y:4,w:2,h:6}, {x:6,y:5,w:1,h:2,c:"#f00"}, {x:9,y:5,w:1,h:2,c:"#f00"}, {x:0,y:2,w:2,h:8}, {x:14,y:2,w:2,h:8}] },
            true_demon: { id: "true_demon", name: "çœŸãƒ»é­”ç‹", color: "#000", pixels: [{x:6,y:1,w:4,h:2}, {x:4,y:3,w:8,h:9}, {x:2,y:4,w:2,h:6}, {x:12,y:4,w:2,h:6}, {x:6,y:5,w:1,h:2,c:"#f00"}, {x:9,y:5,w:1,h:2,c:"#f00"}, {x:0,y:2,w:2,h:8}, {x:14,y:2,w:2,h:8}, {x:7,y:0,w:2,h:1,c:"#ffd700"}] },
            // Metal Slime added
            metal_slime: { id: "metal_slime", name: "ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ", color: "#c0c0c0", pixels: [{x:5,y:5,w:6,h:1}, {x:3,y:6,w:10,h:1}, {x:2,y:7,w:12,h:1}, {x:1,y:8,w:14,h:4}, {x:2,y:12,w:12,h:1}, {x:4,y:9,w:1,h:1,c:"#000"}, {x:11,y:9,w:1,h:1,c:"#000"}] }
        };

        const monsters = [
            Object.assign({}, monsterDefs.slime),    // Lv1
            Object.assign({}, monsterDefs.goblin),   // Lv2
            Object.assign({}, monsterDefs.bat),      // Lv3
            Object.assign({}, monsterDefs.wolf),     // Lv4
            Object.assign({}, monsterDefs.orc),      // Lv5
            Object.assign({}, monsterDefs.skeleton), // Lv6
            Object.assign({}, monsterDefs.golem),    // Lv7
            Object.assign({}, monsterDefs.chimera),  // Lv8
            Object.assign({}, monsterDefs.dragon),   // Lv9
            Object.assign({}, monsterDefs.reaper),   // Lv10
            Object.assign({}, monsterDefs.dragon, {id: "red_dragon", name: "ãƒ¬ãƒƒãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³", color: "#ff4444"}), // Lv11
            Object.assign({}, monsterDefs.reaper, {id: "strong_reaper", name: "ã—ã«ãŒã¿(å¼·)", color: "#9c27b0"}), // Lv12
            Object.assign({}, monsterDefs.demon)     // Lv13
        ];

        const questions = [
            "ã‚ãŸã—ã¯ã€€ã‹ã¿ã‚µãƒã‚’ã€€ã—ã‚“ã˜ã‚‹ã‹ï¼Ÿ", "ãŠã¾ãˆã¯ã€€ã‚†ã†ã—ã‚ƒã€€ãªã®ã‹ï¼Ÿ", "ã“ã®ã›ã‹ã„ã¯ã€€ã’ã‚“ã˜ã¤ã€€ã‹ï¼Ÿ",
            "ãƒ‘ãƒ³ã¯ã€€ã™ãã‹ï¼Ÿ", "ã†ã—ã‚ã«ã€€ã ã‚Œã‹ã€€ã„ã‚‹ã‹ï¼Ÿ", "ã˜ã‹ã‚“ã¯ã€€ã‚€ã’ã‚“ã€€ã‹ï¼Ÿ",
            "ãŠãªã‹ã¯ã€€ã™ã„ãŸã‹ï¼Ÿ", "ãƒœã‚¿ãƒ³ã‚’ã€€ãŠã™ã€€ã‹ãã”ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ", "ãã‚‡ã†ã¯ã€€ã„ã„ã€€ã¦ã‚“ãã‹ï¼Ÿ",
            "ãŠã¾ãˆã«ã€€ã¨ã‚‚ã ã¡ã¯ã€€ã„ã‚‹ã‹ï¼Ÿ", "ã“ã®ã€€ãŸãŸã‹ã„ã¯ã€€ãŸã®ã—ã„ã‹ï¼Ÿ", "ã†ã¾ã‚Œã‹ã‚ã‚ŠãŸã„ã‹ï¼Ÿ",
            "ã“ã“ã¯ã€€ã˜ã”ãã€€ã‹ï¼Ÿ", "ãŠã¾ãˆã®ã€€ãªã¾ãˆã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ", "ã›ã‹ã„ã‚’ã€€ã™ãã†ã€€ãã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ",
            "ã¾ã ã€€ã‚ãã‚‰ã‚ãªã„ã€€ã¤ã‚‚ã‚Šã‹ï¼Ÿ", "ã­ã‚€ãã€€ãªã„ã‹ï¼Ÿ", "ã¾ã»ã†ã¯ã€€ã¤ã‹ãˆã‚‹ã‹ï¼Ÿ",
            "ã‚„ã¿ã¯ã€€ã“ã‚ã„ã‹ï¼Ÿ", "ã­ã“ã¯ã€€ã™ãã‹ï¼Ÿ", "ãŠã‹ã­ã¯ã€€ã»ã—ã„ã‹ï¼Ÿ",
            "ãˆã„ãˆã‚“ã®ã€€ã„ã®ã¡ã¯ã€€ã»ã—ã„ã‹ï¼Ÿ", "ãŠã¾ãˆã¯ã€€ãƒ­ãƒœãƒƒãƒˆã‹ï¼Ÿ", "ã“ã“ã‚ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ",
            "ã‚ã—ãŸã¯ã€€ãã‚‹ã¨ã€€ãŠã‚‚ã†ã‹ï¼Ÿ", "ã‹ã“ã«ã€€ã‚‚ã©ã‚ŠãŸã„ã‹ï¼Ÿ", "ã†ãã‚’ã€€ã¤ã„ãŸã“ã¨ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ",
            "ã²ã¿ã¤ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ", "ãŸãŸã‹ã†ã‹ï¼Ÿ", "ã«ã’ã‚‹ã‹ï¼Ÿ",
            "ãªããã†ã«ã€€ãªã£ãŸã“ã¨ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ", "ã‚ã‚‰ã£ãŸã“ã¨ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ", "ã ã‚Œã‹ã‚’ã€€ã‚ã„ã—ã¦ã„ã‚‹ã‹ï¼Ÿ",
            "ã²ã¨ã‚Šã¼ã£ã¡ã¯ã€€ã•ã³ã—ã„ã‹ï¼Ÿ", "ã‚ˆã‚‹ã¯ã€€ãã‚‰ã„ã‹ï¼Ÿ", "ã‚ã•ã¯ã€€ã¾ã¶ã—ã„ã‹ï¼Ÿ",
            "ãŸã„ã‚ˆã†ã¯ã€€ã‚ã¤ã„ã‹ï¼Ÿ", "ã¿ãšã¯ã€€ã¤ã‚ãŸã„ã‹ï¼Ÿ", "ã‚†ãã¯ã€€ã—ã‚ã„ã‹ï¼Ÿ",
            "ã¨ã‚Šã¯ã€€ã†ãŸã†ã‹ï¼Ÿ", "ã¿ã¡ã¯ã€€ã¤ã¥ãã‹ï¼Ÿ", "ã‚´ãƒ¼ãƒ«ã¯ã€€ã‚ã‚‹ã‹ï¼Ÿ",
            "ã„ã¾ã¯ã€€ã„ã¤ã ï¼Ÿ", "ãŠã¾ãˆã¯ã€€ã ã‚Œã ï¼Ÿ", "ãƒªãƒ³ã‚´ã¯ã€€ã‚ã‹ã„ã‹ï¼Ÿ",
            "ã™ã¹ã¦ã¯ã€€ã‚†ã‚ã‹ï¼Ÿ", "ã‚ã‚’ã€€ã•ã¾ã—ãŸã„ã‹ï¼Ÿ", "ã¾ã ã€€ã­ã¦ã„ãŸã„ã‹ï¼Ÿ",
            "ãŠãªã‹ãŒã€€ã„ãŸã„ã‹ï¼Ÿ", "ã‚ãŸã¾ãŒã€€ã„ãŸã„ã‹ï¼Ÿ", "ã’ã‚“ãã€€ã‹ï¼Ÿ",
            "ã¤ã‹ã‚ŒãŸã‹ï¼Ÿ", "ã‚„ã™ã¿ãŸã„ã‹ï¼Ÿ", "ã‚‚ã£ã¨ã€€ã‚ãã³ãŸã„ã‹ï¼Ÿ",
            "ãŠã¾ãˆã¯ã€€ã„ãã¦ã€€ã„ã‚‹ã‹ï¼Ÿ", "ã‚ãŸã—ã‚’ã€€ãŸãŠã›ã‚‹ã‹ï¼Ÿ"
        ];

        window.onload = () => {
            loadData();
            updateVisualBtn();
            startLevel(1);
        };

        // --- Auto Mode Control ---
        function toggleAutoMode() {
            isAutoMode = !isAutoMode;
            const btn = document.getElementById('auto-btn');
            
            if(isAutoMode) {
                btn.innerText = "AUTO ON";
                btn.classList.add('active');
                SoundManager.init(); // Ensure audio context on click
                processAutoTurn();
            } else {
                btn.innerText = "AUTO OFF";
                btn.classList.remove('active');
                if(autoTimeout) clearTimeout(autoTimeout);
            }
        }

        // --- Visual Mode Control ---
        function toggleVisualMode() {
            gameSettings.isPixelMode = !gameSettings.isPixelMode;
            updateVisualBtn();
            saveSettings();
            
            if (currentMonster && !document.getElementById('overlay').classList.contains('active')) {
                renderMonsterVisual(currentMonster);
            }
        }

        function updateVisualBtn() {
            const btn = document.getElementById('visual-btn');
            btn.innerText = gameSettings.isPixelMode ? "DOT" : "IMG";
        }

        function processAutoTurn() {
            if(!isAutoMode || isProcessing) return;

            const overlay = document.getElementById('overlay');
            if(overlay.classList.contains('active')) return;

            // æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸(Lv13)ãªã‚‰å¼·åˆ¶åœæ­¢
            if (currentFloor === 13) {
                isAutoMode = false;
                document.getElementById('auto-btn').innerText = "AUTO OFF";
                document.getElementById('auto-btn').classList.remove('active');
                log("â˜…æœ€çµ‚æ±ºæˆ¦ï¼ ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ ã‹ã„ã˜ã‚‡ã—ã¾ã—ãŸã€‚", false, 'system');
                return;
            }

            if(bestRecord.floor > 0 && currentFloor === bestRecord.floor) {
                isAutoMode = false;
                document.getElementById('auto-btn').innerText = "AUTO OFF";
                document.getElementById('auto-btn').classList.remove('active');
                log("â˜…ãƒã‚¤ã‚¹ã‚³ã‚¢ã¨ã†ãŸã¤ï¼ ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ ã‹ã„ã˜ã‚‡ã—ã¾ã—ãŸã€‚", false, 'system');
                return;
            }

            const choice = Math.random() < 0.5 ? 'left' : 'right';
            
            const btnId = choice === 'left' ? 'btn-yes' : 'btn-no';
            const btn = document.getElementById(btnId);
            btn.style.color = '#ffff00';
            setTimeout(() => btn.style.color = '#fff', 100);

            makeChoice(choice);
        }

        // --- Help & Bestiary Control ---
        function openHelp() {
            document.getElementById('help-overlay').classList.add('active');
        }
        function closeHelp() {
            document.getElementById('help-overlay').classList.remove('active');
        }

        // --- Core Game Logic ---

        function startLevel(lvl) {
            currentFloor = lvl;
            determineFate();
            spawnMonster();
            updateUI();
            isProcessing = false;
            
            if(lvl === 1) {
                playerLevel = 1; // Reset Player Level on new game
                statsRecord.totalAttempts++;
                saveData(); 
                
                log(`[B${lvl}F] ${currentMonster.name}ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼`);
                document.getElementById('message-window').innerText = `${currentMonster.name}ã€Œ${getRandomQuestion()}ã€`;
                
                if(isAutoMode) {
                    autoTimeout = setTimeout(processAutoTurn, 500);
                }
            }
        }

        function determineFate() {
            const roll = Math.random();
            predeterminedFate = roll < 0.5 ? 'left' : 'right';
            console.log(`[DEBUG] Next Fate: ${predeterminedFate === 'left' ? 'YES' : 'NO'}`);
        }

        function spawnMonster() {
            const idx = currentFloor - 1;
            
            // True Demon Chance at Level 13
            if (currentFloor === 13 && Math.random() < 0.1) {
                currentMonster = Object.assign({}, monsterDefs.true_demon);
                document.body.classList.add('true-demon-mode');
                log("ï¼ï¼ï¼ã€€ã—ã‚“ã®ã€€ã¾ãŠã†ãŒã€€ã‚ã‚‰ã‚ã‚ŒãŸã€€ï¼ï¼ï¼", false, 'true-boss');
            } 
            // Metal Slime Chance (Not last floor)
            else if (currentFloor < 13 && Math.random() < 0.033) { // 1/30
                currentMonster = Object.assign({}, monsterDefs.metal_slime);
                log("ï¼ã€€ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ãŒã€€ã‚ã‚‰ã‚ã‚ŒãŸã€€ï¼", false, 'metal');
            }
            // Regular Monster
            else if (idx < monsters.length) {
                currentMonster = monsters[idx];
            } else {
                currentMonster = monsters[monsters.length - 1];
            }

            renderMonsterVisual(currentMonster);
        }

        function renderMonsterVisual(monster) {
            const container = document.getElementById('monster-visual');
            container.innerHTML = '';
            container.className = ''; 
            
            if(monster.id === 'true_demon') {
                container.className = 'true-demon-visual';
            } else if (monster.id === 'metal_slime') {
                container.className = 'metal-visual';
            }

            if (gameSettings.isPixelMode) {
                container.innerHTML = generateMonsterSVG(monster);
                return;
            }

            const imgPath = `img/${monster.id}.png`;
            const img = document.createElement('img');
            img.src = imgPath;
            img.alt = monster.name;
            
            img.onerror = function() {
                this.remove();
                container.innerHTML = generateMonsterSVG(monster);
            };

            container.appendChild(img);
        }

        function getRandomQuestion() {
            return questions[Math.floor(Math.random() * questions.length)];
        }

        function makeChoice(choice) {
            if(isProcessing) return; 
            isProcessing = true;
            SoundManager.init();

            statsRecord.totalChoices++;
            saveData();

            if (choice === 'left') choiceStats.yes++;
            else choiceStats.no++;
            const isCorrect = (choice === predeterminedFate);
            
            log(`â–¶ ${choice === 'left' ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);

            if (isCorrect) {
                handleSuccess();
            } else {
                handleFailure();
            }
        }

        function handleSuccess() {
            SoundManager.playAttack(); 

            statsRecord.totalSuccesses++;
            saveData();

            const vis = document.getElementById('monster-visual');
            vis.classList.add('anim-damage');
            vis.classList.add('anim-shake');
            
            log(`${currentMonster.name}ã« ${playerStats.atk}ã® ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
            log(`${currentMonster.name}ã‚’ ãŸãŠã—ãŸï¼`, false, 'success');

            let levelGain = 1;
            if (currentMonster.id === 'metal_slime') {
                levelGain = 5;
            }
            levelUp(levelGain);

            const nextDelay = isAutoMode ? 400 : 800; 

            if (currentFloor === 13) {
                if (currentMonster.id === 'true_demon') {
                    statsRecord.trueClears = (statsRecord.trueClears || 0) + 1;
                    isTrueClear = true;
                }
                
                // çœŸãƒ»é­”ç‹æœªè¨ä¼æ™‚ã®é€šå¸¸é­”ç‹æ’ƒç ´æ™‚æ¼”å‡º
                if (currentMonster.id === 'demon' && statsRecord.trueClears === 0) {
                     setTimeout(showDemonLastWords, 1000);
                     return; 
                }

                statsRecord.totalClears++; 
                saveData();
                setTimeout(() => {
                    showGameClear();
                }, 1000);
            } else {
                setTimeout(() => {
                    currentFloor++;
                    determineFate();
                    spawnMonster();
                    
                    log(`[B${currentFloor}F] ${currentMonster.name}ãŒ ã‚ã‚‰ã‚ã‚ŒãŸï¼`);
                    document.getElementById('message-window').innerText = `${currentMonster.name}ã€Œ${getRandomQuestion()}ã€`;
                    updateUI();
                    
                    isProcessing = false;
                    if(isAutoMode) {
                        autoTimeout = setTimeout(processAutoTurn, 400);
                    }
                }, nextDelay);
            }
        }
        
        function showDemonLastWords() {
            const msgWin = document.getElementById('message-window');
            const vis = document.getElementById('monster-visual');
            
            // æ¼”å‡ºé–‹å§‹
            vis.classList.add('anim-talk');
            msgWin.innerHTML = `${currentMonster.name}ã€Œã‚°ãƒ•ãƒƒâ€¦â€¦ã€€ã‚ãŸã—ã‚’ãŸãŠã™ã¨ã¯â€¦â€¦ã€`;
            
            setTimeout(() => {
                vis.classList.add('anim-talk');
                msgWin.innerHTML = `${currentMonster.name}ã€Œã ãŒã€€ã—ã‚“ã®ãã‚‡ã†ãµã¯ã€€ã“ã‚Œã‹ã‚‰ã â€¦â€¦ã€`;
                
                setTimeout(() => {
                    vis.classList.add('anim-talk');
                    msgWin.innerHTML = `${currentMonster.name}ã€Œã“ã®ã›ã‹ã„ã«ã¯ã€€ã¾ã ã€€ã‚ã„ã¤ãŒã€€ã„ã‚‹â€¦â€¦ã€`;
                    
                    setTimeout(() => {
                        statsRecord.totalClears++; 
                        saveData();
                        showGameClear();
                    }, 2500);
                }, 2500);
            }, 2500);
        }

        function levelUp(gain = 1) {
            let totalHpUp = 0;
            let totalAtkUp = 0;

            for(let i=0; i<gain; i++) {
                playerLevel++;
                const hpUp = Math.floor(Math.random() * 5) + 1;
                const mpUp = Math.floor(Math.random() * 3);
                const atkUp = Math.floor(Math.random() * 2) + 1;

                playerStats.maxHp += hpUp;
                playerStats.hp = playerStats.maxHp; 
                playerStats.maxMp += mpUp;
                playerStats.mp = playerStats.maxMp;
                playerStats.atk += atkUp;
                
                totalHpUp += hpUp;
                totalAtkUp += atkUp;
            }
            playerStats.hp = playerStats.maxHp; 
            playerStats.mp = playerStats.maxMp;

            setTimeout(() => SoundManager.playLevelUp(), 200); 
            log(`ãƒ¬ãƒ™ãƒ«ãŒ${gain}ã‚ãŒã£ãŸï¼ (HP+${totalHpUp}, æ”»+${totalAtkUp})`, false, 'levelup');

            if (Math.random() < 0.3) {
                dropItem();
            }
        }

        function dropItem(forceRare = false) {
            let itemName = "";
            let isRare = false;

            if (forceRare) {
                const randIndex = Math.floor(Math.random() * rareItems.length);
                itemName = rareItems[randIndex];
                isRare = true;
            } else if (Math.random() < 0.3) {
                const maxIdx = weaponNames.length - 1;
                const tier = Math.min(maxIdx, Math.floor((currentFloor / 13) * maxIdx));
                const range = 15; 
                const randIndex = Math.max(0, Math.min(maxIdx, tier - 5 + Math.floor(Math.random() * range)));
                itemName = weaponNames[randIndex];
            } else {
                itemName = itemNames[Math.floor(Math.random() * itemNames.length)];
            }
            
            playerStats.items.push(itemName);
            const dropMsg = isRare ? `â˜…ãƒ¬ã‚¢ï¼ ${itemName}ã‚’ ãŠã¨ã—ãŸï¼` : `${itemName}ã‚’ ãŠã¨ã—ãŸï¼`;
            log(`${currentMonster.name}ã¯ ${dropMsg}`, false, 'item');
        }

        function handleFailure() {
            SoundManager.playDamage(); 

            const vis = document.getElementById('monster-visual');
            vis.classList.add('anim-attack');

            document.getElementById('message-window').innerText = `${currentMonster.name}ã® ã“ã†ã’ãï¼`;
            log(`ãƒŸã‚¹ï¼ ã‚†ã†ã—ã‚ƒã¯ ${playerStats.maxHp}ã® ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã†ã‘ãŸï¼`, true);
            playerStats.hp = 0;
            updateUI();

            checkHighScore(); 

            const failDelay = isAutoMode ? 500 : 1000;
            setTimeout(() => {
                showGameOver(false);
            }, failDelay);
        }

        function showGameClear() {
            if (isTrueClear) {
                SoundManager.playTrueClear();
            } else {
                SoundManager.playClear(); 
            }

            isGameClear = true;
            
            if(isAutoMode) {
                isAutoMode = false;
                document.getElementById('auto-btn').classList.remove('active');
                document.getElementById('auto-btn').innerText = "AUTO OFF";
                log("â˜…ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ ã‹ã„ã˜ã‚‡ã—ã¾ã—ãŸã€‚", false, 'system');
            }

            const vis = document.getElementById('monster-visual');
            if (isTrueClear) {
                vis.classList.add('anim-true-clear');
            } else {
                vis.classList.add('anim-clear');
            }
            
            const demonName = isTrueClear ? "çœŸãƒ»é­”ç‹" : "ã¾ãŠã†";
            log(`ãŠã‚ã§ã¨ã†ï¼ ${demonName}ã‚’ ãŸãŠã—ãŸï¼`, false, 'success');
            
            checkHighScore(); 

            setTimeout(() => {
                showGameOver(true);
            }, 1500);
        }

        function checkHighScore() {
            let isNewRecord = false;
            // Compare Floors now
            if (currentFloor > bestRecord.floor) {
                isNewRecord = true;
            } else if (currentFloor === bestRecord.floor) {
                if (playerStats.items.length > bestRecord.items.length) {
                    isNewRecord = true;
                }
            }
            if (isNewRecord) {
                bestRecord = {
                    floor: currentFloor,
                    hp: playerStats.maxHp,
                    mp: playerStats.maxMp,
                    atk: playerStats.atk,
                    items: [...playerStats.items],
                    alias: generateAlias(currentFloor, choiceStats)
                };
                saveData();
                return true;
            }
            return false;
        }

        function showGameOver(isClear) {
            if(!isClear) SoundManager.playGameOver(); 

            const overlay = document.getElementById('overlay');
            const title = document.getElementById('overlay-title');
            const kingMsg = document.getElementById('king-msg'); 
            
            const alias = generateAlias(currentFloor, choiceStats);
            document.getElementById('alias-val').innerText = alias;
            document.getElementById('true-fate-display').innerText = isClear ? "é‹å‘½ã‚’è¶…è¶Šã—ãŸ" : (predeterminedFate === 'left' ? 'ã¯ã„' : 'ã„ã„ãˆ');
            
            // Add to Collections
            addToCollection(playerStats.items, alias);

            overlay.classList.remove('clear-mode', 'true-clear-mode');

            if (isClear) {
                // ãƒ‰ãƒ©ã‚´ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆé¢¨ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›´
                document.getElementById('true-fate-display').parentElement.style.display = 'none';
                
                if (isTrueClear) {
                    overlay.classList.add('true-clear-mode');
                    title.innerText = "ã—ã‚“ã®ã€€ã¸ã„ã‚ãŒã€€ãŠã¨ãšã‚ŒãŸï¼";
                    kingMsg.innerHTML = "ã¿ã”ã¨ã ï¼ã€€ã™ã¹ã¦ã®ã€€ã’ã‚“ãã‚‡ã†ã‚’ã€€ã†ã¡ãŸãŠã™ã¨ã¯ï¼<br>ããªãŸã“ãã€€ã¾ã“ã¨ã®ã€€ã‚†ã†ã—ã‚ƒã ï¼";
                } else {
                    overlay.classList.add('clear-mode');
                    title.innerText = "ã›ã‹ã„ã«ã€€ã¸ã„ã‚ãŒã€€ã‚‚ã©ã£ãŸï¼";
                    kingMsg.innerHTML = "ã‚ˆããã€€ã¾ãŠã†ã‚’ã€€ãŸãŠã—ãŸï¼<br>ããªãŸã®ã€€ã‹ã¤ã‚„ãã¯ã€€ãˆã„ãˆã‚“ã«ã€€ã‹ãŸã‚Šã¤ãŒã‚Œã‚‹ã ã‚ã†ï¼";
                }
            } else {
                title.innerText = "ãœã‚“ã‚ã¤ã€€ã—ãŸâ€¦â€¦";
                kingMsg.innerText = "ã—ã‚“ã§ã—ã¾ã†ã¨ã¯ ãªã•ã‘ãªã„â€¦â€¦"; 
                document.getElementById('true-fate-display').parentElement.style.display = 'block';
            }

            const isNew = (bestRecord.floor === currentFloor && bestRecord.hp === playerStats.maxHp && bestRecord.alias === alias);
            document.getElementById('new-record-badge').style.display = isNew ? 'inline-block' : 'none';

            document.getElementById('res-floor').innerText = "B" + currentFloor + "F";
            document.getElementById('res-lvl').innerText = playerLevel;
            document.getElementById('res-hp').innerText = playerStats.maxHp;
            document.getElementById('res-mp').innerText = playerStats.maxMp;
            document.getElementById('res-atk').innerText = playerStats.atk;
            
            document.getElementById('stat-attempts').innerText = statsRecord.totalAttempts;
            const trueClearsText = statsRecord.trueClears ? ` (çœŸ:${statsRecord.trueClears})` : "";
            document.getElementById('stat-clears').innerHTML = `${statsRecord.totalClears}<small>${trueClearsText}</small>`;
            document.getElementById('stat-choices').innerText = statsRecord.totalChoices;
            
            let rate = 0;
            if (statsRecord.totalChoices > 0) {
                rate = (statsRecord.totalSuccesses / statsRecord.totalChoices) * 100;
            }
            document.getElementById('stat-rate').innerText = rate.toFixed(1) + "%";
            
            const lootContainer = document.getElementById('loot-list');
            lootContainer.innerHTML = '';
            if (playerStats.items.length === 0) {
                lootContainer.innerHTML = '<div style="color:#888;">ãªã—</div>';
            } else {
                playerStats.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'loot-item';
                    div.innerText = item;
                    lootContainer.appendChild(div);
                });
            }

            overlay.classList.add('active');
            document.querySelector('.choices-container').querySelectorAll('button').forEach(b => b.disabled = true);

            // Auto Retry
            if(isAutoMode && !isGameClear) {
                autoTimeout = setTimeout(() => {
                    resetGame();
                }, 1000);
            }
        }

        function resetGame() {
            currentFloor = 0;
            playerLevel = 1;
            choiceStats = { yes: 0, no: 0 };
            isGameClear = false;
            isTrueClear = false;
            document.body.classList.remove('true-demon-mode');
            
            playerStats = {
                hp: 20, maxHp: 20,
                mp: 5, maxMp: 5,
                atk: 10,
                items: []
            };

            document.getElementById('overlay').classList.remove('active');
            document.getElementById('overlay').classList.remove('clear-mode');
            document.getElementById('log-container').innerHTML = '';
            document.querySelector('.choices-container').querySelectorAll('button').forEach(b => b.disabled = false);
            log("ã¼ã†ã‘ã‚“ã® ãã‚ãã‚’ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            
            startLevel(1);
        }
        
        function clearData() {
            if(confirm("ã»ã‚“ã¨ã†ã« ãã‚ãã‚’ ã™ã¹ã¦ ã‘ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒšãƒ¼ã‚¸ãŒ ãƒªãƒ­ãƒ¼ãƒ‰ ã•ã‚Œã¾ã™ï¼‰")) {
                localStorage.removeItem('abyss_rpg_save_v1');
                localStorage.removeItem('abyss_rpg_stats_v1');
                localStorage.removeItem('abyss_rpg_settings_v1'); 
                alert("ãã‚ãã¯ ã¾ã£ã—ã‚‡ã† ã•ã‚Œã¾ã—ãŸã€‚");
                location.reload(); 
            }
        }

        function generateMonsterSVG(data) {
            let rects = "";
            data.pixels.forEach(p => {
                const color = p.c ? p.c : data.color;
                rects += `<rect x="${p.x}" y="${p.y}" width="${p.w}" height="${p.h}" fill="${color}" />`;
            });
            return `<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="pixel-art">${rects}</svg>`;
        }

        function log(msg, isFail = false, type = 'normal') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (isFail) entry.classList.add('fail');
            if (type === 'success') entry.classList.add('success');
            if (type === 'item') entry.classList.add('item');
            if (type === 'levelup') entry.classList.add('levelup');
            if (type === 'system') entry.classList.add('system');
            if (type === 'true-boss') entry.classList.add('true-boss');
            if (type === 'metal') entry.classList.add('metal');
            
            entry.innerHTML = msg; // innerHTML to allow tags in msg
            container.prepend(entry);
        }

        function updateUI() {
            document.getElementById('floor-val').innerText = "B" + currentFloor + "F";
            document.getElementById('level-val').innerText = playerLevel;
            document.getElementById('hp-val').innerText = playerStats.hp;
            document.getElementById('mp-val').innerText = playerStats.mp;
            document.getElementById('atk-val').innerText = playerStats.atk;
            document.getElementById('hs-val-sm').innerText = "B" + bestRecord.floor + "F";
            
            const prob = Math.pow(2, currentFloor);
            let probStr = prob > 999999999 ? "æ¸¬å®šä¸èƒ½" : prob.toLocaleString();
            document.getElementById('prob-val').innerText = probStr;
        }

        // --- Expanded Alias System ---
        function generateAlias(lvl, stats) {
            const total = stats.yes + stats.no;
            if (lvl <= 1) return "ç¬æ®ºã•ã‚Œã—è€…";
            
            const yesRatio = total > 0 ? stats.yes / total : 0;
            
            // Random Prefixes (Massive List)
            const randomPrefixes = [
                "ç–¾é¢¨ã®", "æ€’æ¶›ã®", "å¥‡è·¡ã®", "ä¸å±ˆã®", "å­¤é«˜ã®", "æ¼†é»’ã®", "ç™½éŠ€ã®", "æ„›ã®", "æ‚²ã—ã¿ã®", 
                "é€±æœ«ã®", "æ”¾èª²å¾Œã®", "ç•°ä¸–ç•Œã®", "è»¢ç”Ÿã—ãŸ", "æœ€å¼·ã®", "æœ€å¼±ã®", "é€†è¥²ã®", "è¦šé†’ã—ãŸ",
                "è¿·å­ã®", "è…¹ãƒšã‚³ã®", "å¯ä¸è¶³ã®", "ä¼èª¬ã®", "ã†ã‚ã•ã®", "ãŸã ã®", "æœŸå¾…ã®", "è¦‹ç¿’ã„", "æ°¸é ã®",
                "åœ°ç„ã®", "å¤©å›½ã®", "è™šç„¡ã®", "ç´„æŸã®", "å§‹ã¾ã‚Šã®", "çµ‚ã‚ã‚Šã®", "é‡ç”£å‹", "é«˜æ€§èƒ½", "ãƒãƒ³ã‚³ãƒ„",
                "ã«ã‚ã‹", "ã‚¬ãƒå‹¢", "èª²é‡‘", "ç„¡èª²é‡‘", "ãƒ­ã‚°ã‚¤ãƒ³å‹¢", "å¼•é€€ã—ãŸ", "å¾©å¸°ã—ãŸ", "è‡ªç§°", "å…¬èª",
                "é¸ã°ã‚Œã—", "å‘ªã‚ã‚ŒãŸ", "ç¥ç¦ã•ã‚ŒãŸ", "å¿˜ã‚Œã‚‰ã‚ŒãŸ", "åã‚‚ãªã", "é€šã‚Šã™ãŒã‚Šã®"
            ];
            
            // Random Suffixes (Massive List)
            const randomSuffixes = [
                "æ—…äºº", "æˆ¦å£«", "å‹‡è€…", "é­”ç‹", "ç¥", "ãƒ‹ãƒ¼ãƒˆ", "å­¦ç”Ÿ", "ç¤¾é•·", "ã‚¢ã‚¤ãƒ‰ãƒ«", "çŒ«", "çŠ¬", 
                "ã‚¹ãƒ©ã‚¤ãƒ ", "ãƒ‰ãƒ©ã‚´ãƒ³", "æ¦‚å¿µ", "ã‚·ã‚¹ãƒ†ãƒ ", "ãƒã‚°", "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ", "AI", "ã‚¢ãƒ³ãƒ‰ãƒ­ã‚¤ãƒ‰", "ã‚µã‚¤ãƒœãƒ¼ã‚°",
                "é­”æ³•ä½¿ã„", "åƒ§ä¾¶", "ç›—è³Š", "æ­¦é—˜å®¶", "è³¢è€…", "éŠã³äºº", "å•†äºº", "åŸéŠè©©äºº", "è¸Šã‚Šå­", "æµ·è³Š",
                "ã‚µãƒ ãƒ©ã‚¤", "å¿è€…", "ã‚¬ãƒ³ãƒŠãƒ¼", "ãƒ©ãƒ³ã‚µãƒ¼", "ãƒ©ã‚¤ãƒ€ãƒ¼", "ãƒãƒ¼ã‚µãƒ¼ã‚«ãƒ¼", "ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼", "ã‚¢ã‚µã‚·ãƒ³", "ã‚»ã‚¤ãƒãƒ¼", "ã‚¢ãƒ¼ãƒãƒ£ãƒ¼",
                "æ•‘ä¸–ä¸»", "ç ´å£Šè€…", "å‰µé€ ä¸»", "è¦³æ¸¬è€…", "æ”¯é…è€…", "è¶…è¶Šè€…", "å®ˆè­·è€…", "èª¿åœè€…", "åé€†è€…", "å¾©è®è€…",
                "ãŠã˜ã•ã‚“", "ãŠã°ã•ã‚“", "ãŠå…„ã•ã‚“", "ãŠå§‰ã•ã‚“", "å°‘å¹´", "å°‘å¥³", "èµ¤ã¡ã‚ƒã‚“", "è€äºº", "å¹½éœŠ", "ã‚¾ãƒ³ãƒ“"
            ];

            // Deterministic base prefix (Play Style)
            let basePrefix = "";
            if (yesRatio === 1.0) basePrefix = "å…¨è‚¯å®šã®";
            else if (yesRatio === 0.0) basePrefix = "å…¨å¦å®šã®";
            else if (yesRatio > 0.8) basePrefix = "ã‚¤ã‚¨ã‚¹ãƒãƒ³ãª";
            else if (yesRatio < 0.2) basePrefix = "ç–‘ã„æ·±ã";
            else if (yesRatio > 0.6) basePrefix = "ç´ ç›´ãª";
            else if (yesRatio < 0.4) basePrefix = "åå±ˆãª";
            else if (Math.abs(stats.yes - stats.no) <= 1) basePrefix = "ä¸­ç«‹ãªã‚‹";
            else basePrefix = "æ°—ã¾ãã‚Œãª";

            // Determine final prefix
            let prefix = basePrefix;
            // 50% chance to use random flavor prefix instead
            if (Math.random() > 0.5) {
                prefix = randomPrefixes[Math.floor(Math.random() * randomPrefixes.length)];
            }

            // Determine Suffix based on level tier + random
            let suffix = "";
            const tier = Math.floor(lvl / 2); // 0 to 6+
            
            // Create a subset of suffixes appropriate for level
            let suffixPool = [];
            if (tier <= 2) {
                suffixPool = randomSuffixes.slice(0, 15); // Basic jobs/misc
            } else if (tier <= 5) {
                suffixPool = randomSuffixes.slice(15, 40); // Advanced jobs
            } else {
                suffixPool = randomSuffixes.slice(40); // Epic/Godly titles
            }
            
            // Add a chance to pick ANY suffix for chaos
            if(Math.random() < 0.1) suffixPool = randomSuffixes;
            
            suffix = suffixPool[Math.floor(Math.random() * suffixPool.length)];

            // Special Overrides (Fixed Titles for specific feats)
            if (isTrueClear) return "å› æœå¾‹ã®ç ´å£Šè€…";
            if (lvl === 13) return "é‹å‘½ã®è¶…è¶Šè€…";
            if (lvl === 7 && yesRatio === 1.0) return "ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³";
            if (lvl > 10 && playerStats.items.includes("ã­ã")) return "ã­ãã®ä½¿ã„æ‰‹";
            if (playerStats.items.length > 8 && lvl < 8) return "è²·ã„ç‰©ä¸Šæ‰‹";
            if (lvl === 1 && Math.random() < 0.01) return "å‡ºè½ã¡";

            return prefix + suffix;
        }

        // --- Bestiary / Collection ---
        
        function addToCollection(newItems, newAlias) {
            if(!statsRecord.collectedItems) statsRecord.collectedItems = [];
            if(!statsRecord.collectedAliases) statsRecord.collectedAliases = [];
            
            newItems.forEach(item => {
                if(!statsRecord.collectedItems.includes(item)) {
                    statsRecord.collectedItems.push(item);
                }
            });
            
            if(newAlias && !statsRecord.collectedAliases.includes(newAlias)) {
                statsRecord.collectedAliases.push(newAlias);
            }
            saveData();
        }

        function openBestiary() {
            document.getElementById('bestiary-overlay').classList.add('active');
            switchBestiaryTab('items');
        }

        function closeBestiary() {
            document.getElementById('bestiary-overlay').classList.remove('active');
        }

        function switchBestiaryTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            // Very simple tab switching logic relying on order or text
            if(tab === 'items') tabs[0].classList.add('active');
            else tabs[1].classList.add('active');

            renderBestiaryContent(tab);
        }

        function renderBestiaryContent(tab) {
            const container = document.getElementById('bestiary-content');
            container.innerHTML = '';
            
            const collected = tab === 'items' ? (statsRecord.collectedItems || []) : (statsRecord.collectedAliases || []);
            const allList = tab === 'items' ? allItemsList : collected; // Aliases don't have a fixed "All List" easily, so just show collected
            
            const listEl = document.createElement('div');
            listEl.className = 'collection-list';

            if(tab === 'items') {
                // Show completion rate for items
                const rate = Math.floor((collected.length / allItemsList.length) * 100);
                document.getElementById('collection-rate').innerText = rate + "%";

                allList.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'collection-item';
                    if(collected.includes(item)) {
                        el.innerText = item;
                        el.classList.add('unlocked');
                    } else {
                        el.innerText = "ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ";
                    }
                    listEl.appendChild(el);
                });
            } else {
                // Aliases: just list collected
                document.getElementById('collection-rate').innerText = collected.length + "ç¨®";
                
                // Show most recent first
                [...collected].reverse().forEach(alias => {
                    const el = document.createElement('div');
                    el.className = 'collection-item alias-item unlocked';
                    el.innerText = alias;
                    listEl.appendChild(el);
                });
                if(collected.length === 0) {
                    const el = document.createElement('div');
                    el.className = 'collection-item alias-item';
                    el.innerText = "ã¾ã ç§°å·ã‚’ç²å¾—ã—ã¦ã„ã¾ã›ã‚“";
                    listEl.appendChild(el);
                }
            }
            
            container.appendChild(listEl);
        }

        // --- Settings Management ---
        function saveSettings() {
            localStorage.setItem('abyss_rpg_settings_v1', JSON.stringify(gameSettings));
        }

        function loadSettings() {
            const raw = localStorage.getItem('abyss_rpg_settings_v1');
            if(raw) {
                gameSettings = JSON.parse(raw);
            }
        }

        function saveData() {
            localStorage.setItem('abyss_rpg_save_v1', JSON.stringify(bestRecord));
            localStorage.setItem('abyss_rpg_stats_v1', JSON.stringify(statsRecord));
        }
        
        function loadData() {
            const raw = localStorage.getItem('abyss_rpg_save_v1');
            if(raw) {
                bestRecord = JSON.parse(raw);
                // Migrate old level record to floor if needed
                if(bestRecord.level && !bestRecord.floor) {
                    bestRecord.floor = bestRecord.level;
                }
            } else {
                bestRecord = { floor: 0, items: [], alias: "ãªã—" };
            }
            
            const statsRaw = localStorage.getItem('abyss_rpg_stats_v1');
            if(statsRaw) {
                const loaded = JSON.parse(statsRaw);
                statsRecord = {
                    totalAttempts: loaded.totalAttempts || 0,
                    totalClears: loaded.totalClears || 0,
                    trueClears: loaded.trueClears || 0, // Load true clears
                    totalChoices: loaded.totalChoices || 0,
                    totalSuccesses: loaded.totalSuccesses || 0,
                    collectedItems: loaded.collectedItems || [],
                    collectedAliases: loaded.collectedAliases || []
                };
            } else {
                statsRecord = { totalAttempts: 0, totalClears: 0, trueClears: 0, totalChoices: 0, totalSuccesses: 0, collectedItems: [], collectedAliases: [] };
            }
            
            loadSettings(); 
        }
    </script>
</body>
</html>

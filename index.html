<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUEST of DUALISM -ÈÅãÂëΩ„ÅÆ‰∫åÊäû„Å®13„ÅÆË©¶Á∑¥-</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        :root {
            --bg-color: #000000;
            --text-main: #ffffff;
            --border-color: #ffffff;
            --accent-red: #ff4444;   /* Damage/Fail */
            --accent-blue: #4488ff;  /* Magic/Effect */
            --accent-yellow: #ffeb3b; /* Gold/Item */
            --accent-green: #4caf50; /* HP/Success */
            --font-main: 'DotGothic16', sans-serif;
            --window-border: 2px solid #ffffff;
            --window-radius: 4px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Layout Structure */
        #app-container {
            display: flex;
            flex-direction: column; /* Mobile first stack */
            width: 100%;
            max-width: 800px;
            height: 100vh; 
            background: var(--bg-color);
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        
        @media (min-width: 769px) {
            #app-container {
                flex-direction: row;
                width: 95%;
                height: 90vh;
                border: var(--window-border);
                border-radius: var(--window-radius);
            }
        }

        /* Sidebar (Log) */
        #sidebar {
            width: 100%;
            height: 150px;
            background: #000;
            display: flex;
            flex-direction: column;
            border-top: var(--window-border);
            order: 2; /* Bottom on mobile */
            font-size: 0.9rem;
        }
        
        @media (min-width: 769px) {
            #sidebar {
                width: 300px;
                height: 100%;
                border-top: none;
                border-right: var(--window-border);
                order: 1; /* Left on PC */
            }
        }

        .sidebar-header {
            padding: 5px 10px;
            background: #000;
            border-bottom: var(--window-border);
            color: #fff;
            font-size: 1rem;
            text-align: center;
        }

        #log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column-reverse; 
            scrollbar-width: none;
        }

        .log-entry {
            padding: 2px 0;
            display: flex;
            align-items: center;
            line-height: 1.4;
        }
        .log-entry.fail { color: var(--accent-red); }
        .log-entry.success { color: var(--accent-blue); }
        .log-entry.item { color: var(--accent-yellow); }
        .log-entry.levelup { color: var(--accent-green); }
        .log-entry.system { color: #888; }

        /* Main Game Area */
        #game-area {
            flex: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            position: relative;
            order: 1; /* Top on mobile */
        }
        
        @media (min-width: 769px) {
            #game-area { order: 2; padding: 20px; }
        }

        /* Top Status Bar */
        .status-container {
            width: 100%;
            border: var(--window-border);
            border-radius: var(--window-radius);
            padding: 10px;
            margin-bottom: 10px;
            background: #000;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .status-row {
            display: flex;
            gap: 15px;
            width: 100%;
            font-size: 1.1rem;
        }
        .status-row.secondary {
            font-size: 0.9rem;
            color: #ccc;
            border-top: 1px dashed #555;
            padding-top: 5px;
        }

        .stat-item { display: flex; gap: 5px; }
        .stat-label { color: #aaa; }
        .stat-val { color: #fff; font-weight: bold; }
        .stat-val.hp { color: var(--accent-green); }
        .stat-val.mp { color: var(--accent-blue); }
        
        .top-controls {
            position: absolute; 
            top: 5px; right: 10px; 
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .highscore-display { 
            font-size: 0.8rem; color: var(--accent-yellow); 
            background: #000; padding: 0 5px;
            margin-right: 5px;
        }
        
        .ctrl-btn {
            background: transparent;
            border: 1px solid #555;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            border-radius: 4px;
            font-family: var(--font-main);
            min-width: 30px;
        }
        .ctrl-btn:hover { border-color: #fff; }
        
        .auto-btn.active {
            background: var(--accent-blue);
            color: #000;
            border-color: var(--accent-blue);
            animation: pulse 1s infinite;
        }
        
        /* Visual Toggle Button Style */
        .visual-toggle {
            font-weight: bold;
            width: 40px;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Monster Area */
        #monster-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
            min-height: 150px;
        }

        #monster-visual {
            width: 180px;
            height: 180px;
            transition: transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #monster-visual img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated; 
        }

        /* Animation Classes */
        .anim-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .anim-attack { animation: attack 0.2s forwards; }
        .anim-damage { animation: flashRed 0.5s; }
        .anim-levelup { animation: flashGreen 0.5s; }
        .anim-clear { animation: spinAndScale 1.5s forwards; }

        @keyframes shake { 10%, 90% { transform: translate3d(-4px, 0, 0); } 20%, 80% { transform: translate3d(6px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-8px, 0, 0); } 40%, 60% { transform: translate3d(8px, 0, 0); } }
        @keyframes attack { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        @keyframes flashRed { 0%, 100% { filter: none; } 50% { filter: drop-shadow(0 0 10px red) sepia(100%) hue-rotate(-50deg) saturate(600%); } }
        @keyframes flashGreen { 0%, 100% { filter: none; } 50% { filter: drop-shadow(0 0 10px #4caf50) brightness(1.5); } }
        @keyframes spinAndScale { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.2) rotate(180deg); opacity: 1; filter: invert(1); } 100% { transform: scale(0) rotate(360deg); opacity: 0; } }

        /* Message Window (Question) */
        #message-window {
            width: 100%;
            min-height: 70px;
            border: var(--window-border);
            border-radius: var(--window-radius);
            padding: 10px;
            margin-bottom: 10px;
            font-size: 1rem;
            line-height: 1.4;
            background: #000;
        }

        /* Command Window */
        .command-window {
            width: 100%;
            display: flex;
            justify-content: flex-end; /* Right aligned like RPG */
        }

        .choices-container {
            border: var(--window-border);
            border-radius: var(--window-radius);
            padding: 10px 20px;
            width: 150px;
            background: #000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-family: var(--font-main);
            font-size: 1.2rem;
            text-align: left;
            cursor: pointer;
            padding: 5px;
            position: relative;
        }
        .choice-btn:disabled { color: #555; pointer-events: none; }

        .choice-btn:hover::before {
            content: "‚ñ∂";
            position: absolute;
            left: -15px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink { 50% { opacity: 0; } }

        /* Game Over / Clear Overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }
        #overlay.active { opacity: 1; pointer-events: auto; }
        
        /* Styles for Game Clear */
        #overlay.clear-mode {
            background: linear-gradient(135deg, #000 0%, #1a1a00 100%);
            border: 4px double var(--accent-yellow);
        }
        #overlay.clear-mode .game-over-title {
            color: var(--accent-yellow);
            border-bottom-color: var(--accent-yellow);
            text-shadow: 0 0 10px var(--accent-yellow);
            font-size: 2.5rem;
        }

        .game-over-title { 
            font-size: 2rem; 
            color: var(--accent-red); 
            margin: 20px 0 10px 0;
            border-bottom: 2px solid var(--accent-red);
        }
        
        .king-message {
            color: var(--accent-red);
            font-size: 1rem;
            margin-bottom: 15px;
            font-family: var(--font-main);
        }

        .result-container {
            border: var(--window-border);
            padding: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
            text-align: left;
            background: #000;
        }
        
        .result-header { font-size: 1.2rem; border-bottom: 1px dashed #fff; margin-bottom: 10px; padding-bottom: 5px;}
        .result-stats { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; color: #ccc;}
        
        .loot-list {
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 5px;
            font-size: 0.9rem;
            scrollbar-width: thin;
            margin-bottom: 15px;
        }
        .loot-item { margin-bottom: 2px; color: var(--accent-yellow); }
        
        .new-record {
            color: var(--accent-yellow);
            font-weight: bold;
            animation: blink 1s infinite;
            display: none; 
            margin-left: 10px;
        }

        /* Stats Area in Result */
        .record-stats-area {
            font-size: 0.9rem;
            color: #888;
            margin-top: 10px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 8px;
        }
        .stats-row:last-child { margin-bottom: 0; }

        .record-stat-box { text-align: center; min-width: 80px; }
        .record-stat-num { color: #fff; font-size: 1.2rem; display: block; }
        .record-stat-label { font-size: 0.7rem; display: block; }

        .alias-val { font-size: 1.5rem; color: #fff; font-weight: bold; text-align: center; margin: 10px 0;}

        .restart-btn {
            margin: 10px 0;
            padding: 10px 30px;
            background: transparent;
            border: var(--window-border);
            color: #fff;
            font-family: var(--font-main);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .restart-btn:hover { background: #fff; color: #000; }
        
        .delete-btn {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #555;
            background: transparent;
            border: none;
            cursor: pointer;
            text-decoration: underline;
        }
        .delete-btn:hover { color: var(--accent-red); }

        /* Bestiary Overlay */
        #bestiary-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 60;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        #bestiary-overlay.active { display: flex; }

        .bestiary-header {
            font-size: 1.5rem; color: #fff; text-align: center; margin-bottom: 10px;
            border-bottom: 2px solid #fff; padding-bottom: 5px;
        }
        
        .bestiary-tabs { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .tab-btn {
            background: #000; border: 1px solid #555; color: #aaa; padding: 5px 15px; cursor: pointer;
        }
        .tab-btn.active { border-color: #fff; color: #fff; background: #222; }

        .bestiary-content {
            flex: 1; overflow-y: auto; border: 1px solid #333; padding: 10px;
            font-size: 0.9rem; scrollbar-width: thin;
        }
        
        .collection-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .collection-item {
            padding: 3px 8px; border: 1px solid #333; color: #888;
        }
        .collection-item.unlocked { color: var(--accent-yellow); border-color: var(--accent-yellow); }
        .collection-item.alias-item { color: #aaa; border-color: #444; width: 100%; }
        .collection-item.alias-item.unlocked { color: var(--accent-blue); border-color: var(--accent-blue); }

        .close-bestiary-btn {
            margin-top: 10px; padding: 10px; border: 1px solid #fff; background: #000; color: #fff; cursor: pointer;
        }

        svg { width: 100%; height: 100%; }
        .pixel-art rect { shape-rendering: crispEdges; }

    </style>
</head>
<body>

    <div id="app-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">„Åº„ÅÜ„Åë„Çì„ÅÆ „Åç„Çç„Åè</div>
            <div id="log-container">
                <!-- Logs will be inserted here -->
            </div>
        </aside>

        <!-- Main Game Area -->
        <section id="game-area">
            <div class="top-controls">
                <div class="highscore-display">HI-SCORE: <span id="hs-val-sm">0</span></div>
                <button class="ctrl-btn" onclick="openBestiary()" title="Âõ≥Èëë„ÇíË¶ã„Çã">üìñ</button>
                <button class="ctrl-btn visual-toggle" onclick="toggleVisualMode()" id="visual-btn" title="ÁîªË≥™ÂàáÊõø">IMG</button>
                <button class="ctrl-btn auto-btn" onclick="toggleAutoMode()" id="auto-btn">AUTO OFF</button>
                <button class="ctrl-btn sound-toggle" onclick="SoundManager.toggleMute()" title="„Çµ„Ç¶„É≥„ÉâON/OFF">üîä</button>
            </div>
            
            <!-- Status -->
            <div class="status-container">
                <div class="status-row">
                    <div class="stat-item"><span class="stat-label">LV</span><span class="stat-val" id="level-val">1</span></div>
                    <div class="stat-item"><span class="stat-label">HP</span><span class="stat-val hp" id="hp-val">20</span></div>
                    <div class="stat-item"><span class="stat-label">MP</span><span class="stat-val mp" id="mp-val">5</span></div>
                </div>
                <div class="status-row secondary">
                    <div class="stat-item"><span class="stat-label">„Åì„ÅÜ„Åí„Åç</span><span class="stat-val" id="atk-val">10</span></div>
                    <div class="stat-item" style="margin-left:auto; font-size:0.8rem;"><span class="stat-label">Á¢∫Áéá:</span> 1/<span id="prob-val">2</span></div>
                </div>
            </div>

            <!-- Monster -->
            <div id="monster-container">
                <div id="monster-visual">
                    <!-- Monster will be injected here -->
                </div>
            </div>

            <!-- Message -->
            <div id="message-window">
                „É¢„É≥„Çπ„Çø„Éº„Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ
            </div>

            <!-- Command -->
            <div class="command-window">
                <div class="choices-container">
                    <button class="choice-btn" id="btn-yes" onclick="makeChoice('left')">„ÅØ„ÅÑ</button>
                    <button class="choice-btn" id="btn-no" onclick="makeChoice('right')">„ÅÑ„ÅÑ„Åà</button>
                </div>
            </div>
        </section>

        <!-- Game Over Overlay -->
        <div id="overlay">
            <div class="game-over-title" id="overlay-title">ÂÖ®ÊªÖ„Åó„Åü...</div>
            
            <div id="king-msg" class="king-message"></div>
            
            <div class="result-container">
                <div class="result-header">Áß∞Âè∑: <span id="alias-val">Âêç„ÇÇ„Å™„ÅçÊùë‰∫∫</span></div>
                
                <div id="new-record-badge" class="new-record">‚òÖ NEW RECORD! ‚òÖ</div>

                <div style="text-align:center; font-size:0.9rem; color:#888; margin-bottom:10px;">
                    Ê≠£Ëß£„ÅØ„Äå<span id="true-fate-display"></span>„Äç„Åß„Åó„Åü
                </div>

                <div class="result-header">ÊúÄÁµÇ„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                <div class="result-stats">
                    <span>LV: <span id="res-lvl">1</span></span>
                    <span>HP: <span id="res-hp">0</span></span>
                    <span>MP: <span id="res-mp">0</span></span>
                    <span>Êîª: <span id="res-atk">0</span></span>
                </div>

                <div class="result-header">Áç≤Âæó„Ç¢„Ç§„ÉÜ„É†</div>
                <div class="loot-list" id="loot-list">
                    <!-- Items -->
                </div>
                
                <!-- Adventure Records -->
                <div class="record-stats-area">
                    <!-- Row 1: Play Counts -->
                    <div class="stats-row">
                        <div class="record-stat-box">
                            <span class="record-stat-label">ÂÜíÈô∫ÂõûÊï∞</span>
                            <span class="record-stat-num" id="stat-attempts">0</span>
                        </div>
                        <div class="record-stat-box">
                            <span class="record-stat-label">„ÇØ„É™„Ç¢ÂõûÊï∞</span>
                            <span class="record-stat-num" id="stat-clears">0</span>
                        </div>
                    </div>
                    
                    <!-- Row 2: Choices & Rate -->
                    <div class="stats-row">
                        <div class="record-stat-box">
                            <span class="record-stat-label">Á∑èÈÅ∏ÊäûÊï∞</span>
                            <span class="record-stat-num" id="stat-choices">0</span>
                        </div>
                        <div class="record-stat-box">
                            <span class="record-stat-label">ÈÅãÂëΩÁöÑ‰∏≠Áéá</span>
                            <span class="record-stat-num" id="stat-rate">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="restart-btn" onclick="openBestiary()">üìñ Âõ≥Èëë„ÇíË¶ã„Çã</button>
            <button class="restart-btn" onclick="resetGame()">„Åï„ÅÑ„Åó„Çá„Åã„Çâ</button>
            <br>
            <button class="delete-btn" onclick="clearData()">„Åç„Çç„Åè„Çí „Åæ„Å£„Åó„Çá„ÅÜ „Åô„Çã</button>
        </div>

        <!-- Bestiary Overlay -->
        <div id="bestiary-overlay">
            <div class="bestiary-header">ÂÜíÈô∫„ÅÆÊõ∏ (Âõ≥Èëë)</div>
            <div class="bestiary-tabs">
                <button class="tab-btn active" onclick="switchBestiaryTab('items')">„Ç¢„Ç§„ÉÜ„É†</button>
                <button class="tab-btn" onclick="switchBestiaryTab('aliases')">Áß∞Âè∑</button>
            </div>
            <div style="text-align:right; font-size:0.8rem; margin-bottom:5px; color:#aaa;">
                ÂèéÈõÜÁéá: <span id="collection-rate">0%</span>
            </div>
            <div id="bestiary-content" class="bestiary-content">
                <!-- Content injected by JS -->
            </div>
            <button class="close-bestiary-btn" onclick="closeBestiary()">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <script>
        /**
         * QUEST of DUALISM - Ver 10.0 (Massive Data Expansion)
         */

        // Game State
        let currentLevel = 0;
        let bestRecord = { level: 0, items: [], alias: "„Å™„Åó" }; 
        let statsRecord = { 
            totalAttempts: 0, totalClears: 0, totalChoices: 0, totalSuccesses: 0,
            collectedItems: [], collectedAliases: [] 
        }; 
        let gameSettings = { isPixelMode: false };
        
        let predeterminedFate = null; 
        let choiceStats = { yes: 0, no: 0 };
        let currentMonster = null;
        let isGameClear = false;
        let isProcessing = false;
        
        // Auto Mode
        let isAutoMode = false;
        let autoTimeout = null;
        
        // Player Stats
        let playerStats = {
            hp: 20, maxHp: 20,
            mp: 5, maxMp: 5,
            atk: 10,
            items: []
        };

        // --- Sound Manager ---
        const SoundManager = {
            ctx: null,
            muted: false,
            init: function() {
                if (!this.ctx) {
                    try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
                }
                if (this.ctx && this.ctx.state === 'suspended') { this.ctx.resume(); }
            },
            toggleMute: function() {
                this.muted = !this.muted;
                const btn = document.querySelector('.sound-toggle');
                btn.innerText = this.muted ? "üîá" : "üîä";
                if(!this.muted) this.init();
            },
            playTone: function(freq, type, duration, startTime = 0, vol = 0.1) {
                if (this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + startTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + startTime);
                osc.stop(this.ctx.currentTime + startTime + duration);
            },
            playNoise: function(duration, vol = 0.1) {
                if (this.muted || !this.ctx) return;
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                noise.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },
            playAttack: function() { this.init(); this.playNoise(0.1, 0.2); this.playTone(100, 'square', 0.1, 0, 0.1); },
            playDamage: function() { this.init(); this.playTone(150, 'sawtooth', 0.3, 0, 0.2); this.playTone(100, 'sawtooth', 0.3, 0.1, 0.2); },
            playLevelUp: function() { this.init(); const t = 0.08; this.playTone(523.25, 'square', 0.2, 0); this.playTone(659.25, 'square', 0.2, t); this.playTone(783.99, 'square', 0.2, t*2); this.playTone(1046.50, 'square', 0.4, t*3); },
            playClear: function() { this.init(); const t = 0.12; const v = 0.15; const notes = [523.25, 659.25, 783.99, 1046.50, 0, 783.99, 1046.50]; notes.forEach((freq, i) => { if(freq > 0) this.playTone(freq, 'square', 0.3, i * t, v); }); },
            playGameOver: function() { this.init(); this.playTone(300, 'triangle', 0.5, 0, 0.2); this.playTone(250, 'triangle', 0.5, 0.4, 0.2); this.playTone(200, 'triangle', 1.0, 0.8, 0.2); }
        };

        // --- Data Lists (Massive Expansion) ---
        
        // 90 Weapons
        const weaponNames = [
            "„Å≤„ÅÆ„Åç„ÅÆ„Åº„ÅÜ", "„Åì„Çì„Åº„ÅÜ", "„Å©„ÅÜ„ÅÆ„Å§„Çã„Åé", "„Å¶„Å§„ÅÆ„ÇÑ„Çä", "„ÅØ„Åå„Å≠„ÅÆ„Å§„Çã„Åé", "„Åæ„Å©„ÅÜ„Åó„ÅÆ„Å§„Åà", "„Éë„É´„ÉÅ„Ç∂„É≥", "„ÅØ„Åò„ÇÉ„ÅÆ„Å§„Çã„Åé", "„Åª„ÅÆ„Åä„ÅÆ„Å§„Çã„Åé", "„Åì„Åä„Çä„ÅÆ„ÇÑ„ÅÑ„Å∞", 
            "„Éâ„É©„Ç¥„É≥„Ç≠„É©„Éº", "„ÅÇ„Åè„Åæ„ÅÆ„Ç™„Éé", "„Çâ„ÅÑ„Åò„Çì„ÅÆ„Åë„Çì", "„Å≤„Åã„Çä„ÅÆ„Å§„Çã„Åé", "„ÇÜ„ÅÜ„Åó„ÇÉ„ÅÆ„Å§„Çã„Åé", "„Åß„Çì„Åõ„Å§„ÅÆ„Å∂„Åç", "„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº", "„É©„Ç∞„Éä„É≠„ÇØ", "„Ç∞„É≥„Ç∞„Éã„É´", "„É†„É©„Éû„Çµ", 
            "„É≠„É≥„ÇÆ„Éå„Çπ", "„Ç≤„Ç§„Éú„É´„Ç∞", "„ÇØ„Çµ„Éä„ÇÆ", "Á´πÊßç", "„Éï„É©„Ç§„Éë„É≥", "„Éè„É™„Çª„É≥", "„Éî„Ç≥„Éî„Ç≥„Éè„É≥„Éû„Éº", "„Éì„Éº„É†„Çµ„Éº„Éô„É´", "„Å≠„Åé", "„Ç§„Éº„Ç∏„Çπ„ÅÆ„Åü„Å¶",
            "ÈåÜ„Å≥„ÅüÁü≠Ââ£", "„Ç¨„É©„Çπ„ÅÆÂâ£", "„Éú„Éº„É≥„ÇØ„É©„Éñ", "„Éü„Çπ„É™„É´„ÇΩ„Éº„Éâ", "„Ç™„É™„Éè„É´„Ç≥„É≥„ÉÄ„Ç¨„Éº", "È≠îÂâ£„Ç∞„É©„É†", "ËÅñÂâ£„Éá„É•„É©„É≥„ÉÄ„É´", "Á•ûÊßç„Éñ„É™„É•„Éº„Éä„ÇØ", "ÊñπÂ§©ÁîªÊàü", "ÈùíÈæçÂàÄ",
            "„Éå„É≥„ÉÅ„É£„ÇØ", "„Éñ„Éº„É°„É©„É≥", "„É®„Éº„É®„Éº", "„Çø„É≠„ÉÉ„Éà„Ç´„Éº„Éâ", "Ê∞¥Êô∂Áéâ", "ËæûÊõ∏", "ÂÆöË¶è", "„É¢„ÉÉ„Éó", "„ÉÅ„Çß„Éº„É≥„ÇΩ„Éº", "ÂÜ∑Âáç„Éû„Ç∞„É≠",
            "ÂÖâÁ∑öÈäÉ", "„É≠„Ç±„ÉÉ„Éà„É©„É≥„ÉÅ„É£„Éº", "ÊâãÊ¶¥Âºæ", "„É¢„Éº„Éã„É≥„Ç∞„Çπ„Çø„Éº", "„Éê„Éà„É´„Ç¢„ÉÉ„ÇØ„Çπ", "„Ç¶„Ç©„Éº„Éè„É≥„Éû„Éº", "„É©„É≥„Çπ", "„Éè„É´„Éê„Éº„Éâ", "„Éà„É©„Ç§„Éá„É≥„Éà", "„ÇØ„É≠„Çπ„Éú„Ç¶",
            "„Ç∑„Éß„Éº„Éà„Éú„Ç¶", "„É≠„É≥„Ç∞„Éú„Ç¶", "„Ç¢„Éº„Éê„É¨„Çπ„Éà", "„Åè„Å™„ÅÑ", "ÊâãË£èÂâ£", "„Åæ„Åç„Å≥„Åó", "ÂøçËÄÖÂàÄ", "„Åè„Å™„ÅÑ", "ÂçÅÊâã", "ÈéñÈéå",
            "„Éê„Éº„É´„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ", "ÈáëÂ±û„Éê„ÉÉ„Éà", "„Çπ„Ç≥„ÉÉ„Éó", "„ÉÑ„É´„Éè„Ç∑", "„Éé„Ç≥„ÇÆ„É™", "„Åã„Å™„Å•„Å°", "„Éâ„É©„Ç§„Éê„Éº", "„Çπ„Éë„Éä", "„Éë„Ç§„Éó„É¨„É≥„ÉÅ", "„Éâ„É™„É´",
            "„ÇÆ„Çø„Éº", "„Éû„Ç§„ÇØ", "„Éâ„É©„É†„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ", "ÊåáÊèÆÊ£í", "Á≠Ü", "‰∏áÂπ¥Á≠Ü", "„Åù„Çç„Å∞„Çì", "ÈõªÂçì", "„Çπ„Éû„Éõ", "„Çø„Éñ„É¨„ÉÉ„Éà"
        ];
        
        // 80 Items
        const itemNames = [
            "„ÇÑ„Åè„Åù„ÅÜ", "„Å©„Åè„Åë„Åó„Åù„ÅÜ", "„Åõ„ÅÑ„Åô„ÅÑ", "„Å°„Åã„Çâ„ÅÆ„Åü„Å≠", "„Åæ„ÇÇ„Çä„ÅÆ„Åü„Å≠", "„Åô„Å∞„ÇÑ„Åï„ÅÆ„Åü„Å≠", "„ÅÑ„ÅÆ„Å°„ÅÆ„Åç„ÅÆ„Åø", "„Åµ„Åó„Åé„Å™„Åç„ÅÆ„Åø", "„Ç®„É´„Éï„ÅÆ„ÅÆ„Åø„Åê„Åô„Çä", "„Åõ„Åã„ÅÑ„Åò„ÇÖ„ÅÆ„ÅØ",
            "„Åë„Çì„Åò„ÇÉ„ÅÆ„ÅÑ„Åó", "„Ç®„É™„ÇØ„Çµ„Éº", "„É©„Çπ„Éà„Ç®„É™„ÇØ„Çµ„Éº", "„Åä„Å´„Åé„Çä", "„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ", "„Éù„Éº„Ç∑„Éß„É≥", "„Éè„Ç§„Éù„Éº„Ç∑„Éß„É≥", "„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ„ÅÆÂ∞æ", "„Åç„Çì„ÅÆ„ÅÆ„Åπ„Åº„ÅÜ", "„Ç¨„É©„ÇØ„Çø",
            "Áü≥„Åì„Çç", "Á©∫„ÅçÁº∂", "„Éú„É≠Â∏É", "„Åü„Å†„ÅÆÁ¥ôÂàá„Çå", "„É©„Éñ„É¨„Çø„Éº", "ÂÆù„ÅÆÂú∞Âõ≥", "Ë∫´‰ª£„Çè„Çä‰∫∫ÂΩ¢", "ÁÖôÁéâ", "ÂÖµÁ≥ß‰∏∏", "ÊøÄËæõ„Ç´„É¨„Éº",
            "„Çπ„ÉÜ„Éº„Ç≠", "„Éè„É≥„Éê„Éº„Ç¨„Éº", "„Éî„Ç∂", "ÂØøÂè∏", "„É©„Éº„É°„É≥", "„ÅÜ„Å©„Çì", "„Åù„Å∞", "„Éë„Çπ„Çø", "„Ç™„É†„É©„Ç§„Çπ", "„Ç∞„É©„Çø„É≥",
            "„Ç∑„Éß„Éº„Éà„Ç±„Éº„Ç≠", "„Éó„É™„É≥", "„Çº„É™„Éº", "„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†", "„ÉÅ„Éß„Ç≥„É¨„Éº„Éà", "„Ç≠„É£„É≥„Éá„Ç£", "„ÇØ„ÉÉ„Ç≠„Éº", "„Éâ„Éº„Éä„ÉÑ", "„Éû„Ç´„É≠„É≥", "„Çø„Éî„Ç™„Ç´",
            "„ÉÄ„Ç§„É§„É¢„É≥„Éâ", "„É´„Éì„Éº", "„Çµ„Éï„Ç°„Ç§„Ç¢", "„Ç®„É°„É©„É´„Éâ", "„Éà„Éë„Éº„Ç∫", "„Ç¢„É°„Ç∏„Çπ„Éà", "„Ç™„Éë„Éº„É´", "„Ç¨„Éº„Éç„ÉÉ„Éà", "„Ç¢„ÇØ„Ç¢„Éû„É™„É≥", "„Éö„É™„Éâ„ÉÉ„Éà",
            "ÈâÑÈâ±Áü≥", "ÈäÖÈâ±Áü≥", "ÈäÄÈâ±Áü≥", "ÈáëÈâ±Áü≥", "„Éü„Çπ„É™„É´Èâ±Áü≥", "„Ç™„É™„Éè„É´„Ç≥„É≥Èâ±Áü≥", "„Ç¢„ÉÄ„Éû„É≥„Çø„Ç§„Éà", "„ÉÄ„Éº„ÇØ„Éû„Çø„Éº", "Ë≥¢ËÄÖ„ÅÆÁü≥„ÅÆ„Åã„Åë„Çâ", "Êòü„ÅÆÁ†Ç",
            "„Éâ„É©„Ç¥„É≥„ÅÆÈ±ó", "„É¶„Éã„Ç≥„Éº„É≥„ÅÆËßí", "„Ç∞„É™„Éï„Ç©„É≥„ÅÆÁæΩ", "„Çπ„É©„Ç§„É†„ÅÆ‰ΩìÊ∂≤", "„Ç¥„Éñ„É™„É≥„ÅÆËÖ∞Â∏É", "„Ç™„Éº„ÇØ„ÅÆÁâô", "Âê∏Ë°ÄÈ¨º„ÅÆÁÅ∞", "ÊÇ™È≠î„ÅÆ„Åó„Å£„ÅΩ", "Â§©‰Ωø„ÅÆËº™", "Á•û„ÅÆÊ∂ô"
        ];

        // All Items list for Bestiary
        const allItemsList = [...weaponNames, ...itemNames].sort();

        // Monster Definitions (unchanged but structure kept)
        const monsterDefs = {
            slime: { id: "slime", name: "„Çπ„É©„Ç§„É†", color: "#4488ff", pixels: [{x:5,y:5,w:6,h:1}, {x:3,y:6,w:10,h:1}, {x:2,y:7,w:12,h:1}, {x:1,y:8,w:14,h:4}, {x:2,y:12,w:12,h:1}, {x:4,y:9,w:1,h:1,c:"#000"}, {x:11,y:9,w:1,h:1,c:"#000"}] },
            goblin: { id: "goblin", name: "„Ç¥„Éñ„É™„É≥", color: "#4caf50", pixels: [{x:4,y:3,w:8,h:5}, {x:2,y:4,w:2,h:3}, {x:12,y:4,w:2,h:3}, {x:5,y:5,w:1,h:1,c:"#000"}, {x:10,y:5,w:1,h:1,c:"#000"}, {x:6,y:7,w:4,h:1,c:"#000"}, {x:4,y:8,w:8,h:6}, {x:2,y:9,w:2,h:3}, {x:12,y:9,w:2,h:3}] },
            bat: { id: "bat", name: "„Ç≥„Ç¶„É¢„É™", color: "#aa44ff", pixels: [{x:1,y:4,w:2,h:3}, {x:3,y:6,w:1,h:2}, {x:4,y:7,w:1,h:2}, {x:5,y:8,w:1,h:1}, {x:13,y:4,w:2,h:3}, {x:12,y:6,w:1,h:2}, {x:11,y:7,w:1,h:2}, {x:10,y:8,w:1,h:1}, {x:6,y:6,w:4,h:4}, {x:7,y:7,w:1,h:1,c:"#fff"}, {x:9,y:7,w:1,h:1,c:"#fff"}] },
            wolf: { id: "wolf", name: "„Ç¶„É´„Éï", color: "#9e9e9e", pixels: [{x:2,y:5,w:4,h:4}, {x:6,y:6,w:8,h:5}, {x:6,y:11,w:2,h:3}, {x:12,y:11,w:2,h:3}, {x:3,y:6,w:1,h:1,c:"#fff"}, {x:14,y:7,w:2,h:2}] },
            orc: { id: "orc", name: "„Ç™„Éº„ÇØ", color: "#795548", pixels: [{x:4,y:2,w:8,h:6}, {x:3,y:4,w:1,h:2}, {x:12,y:4,w:1,h:2}, {x:5,y:9,w:6,h:5}, {x:5,y:5,w:1,h:1,c:"#000"}, {x:10,y:5,w:1,h:1,c:"#000"}, {x:6,y:7,w:1,h:2,c:"#fff"}, {x:9,y:7,w:1,h:2,c:"#fff"}] },
            skeleton: { id: "skeleton", name: "„Ç¨„Ç§„Ç≥„ÉÑ", color: "#e0e0e0", pixels: [{x:5,y:2,w:6,h:1}, {x:4,y:3,w:8,h:1}, {x:3,y:4,w:10,h:4}, {x:5,y:5,w:2,h:2,c:"#000"}, {x:9,y:5,w:2,h:2,c:"#000"}, {x:7,y:9,w:2,h:1,c:"#000"}, {x:4,y:10,w:8,h:1}, {x:5,y:11,w:6,h:1}, {x:5,y:12,w:1,h:2}, {x:7,y:12,w:1,h:2}, {x:9,y:12,w:1,h:2}] },
            golem: { id: "golem", name: "„Ç¥„Éº„É¨„É†", color: "#c19a6b", pixels: [{x:4,y:1,w:8,h:5}, {x:5,y:3,w:1,h:1,c:"#f00"}, {x:10,y:3,w:1,h:1,c:"#f00"}, {x:2,y:6,w:12,h:6}, {x:1,y:7,w:1,h:4}, {x:14,y:7,w:1,h:4}, {x:4,y:12,w:3,h:3}, {x:9,y:12,w:3,h:3}] },
            chimera: { id: "chimera", name: "„Ç≠„É°„É©", color: "#e91e63", pixels: [{x:6,y:2,w:4,h:4}, {x:4,y:6,w:8,h:5}, {x:1,y:4,w:3,h:6}, {x:12,y:4,w:3,h:6}, {x:7,y:3,w:1,h:1,c:"#000"}, {x:5,y:11,w:2,h:3}, {x:9,y:11,w:2,h:3}] },
            dragon: { id: "dragon", name: "„Éâ„É©„Ç¥„É≥", color: "#44ff44", pixels: [{x:2,y:8,w:12,h:6}, {x:4,y:4,w:4,h:4}, {x:3,y:3,w:1,h:2}, {x:8,y:3,w:1,h:3}, {x:5,y:5,w:1,h:1,c:"#000"}, {x:0,y:7,w:3,h:3}, {x:12,y:6,w:4,h:3}, {x:3,y:10,w:10,h:3,c:"#ffffaa"}] },
            reaper: { id: "reaper", name: "„Åó„Å´„Åå„Åø", color: "#607d8b", pixels: [{x:6,y:2,w:4,h:4}, {x:5,y:6,w:6,h:8}, {x:12,y:3,w:1,h:10,c:"#aaa"}, {x:11,y:3,w:3,h:1,c:"#aaa"}, {x:4,y:8,w:8,h:0}, {x:7,y:3,w:1,h:1,c:"#000"}, {x:8,y:3,w:1,h:1,c:"#000"}, {x:3,y:6,w:2,h:6, c:"#444"}] },
            demon: { id: "demon", name: "„Åæ„Åä„ÅÜ", color: "#8800ff", pixels: [{x:6,y:1,w:4,h:2}, {x:4,y:3,w:8,h:9}, {x:2,y:4,w:2,h:6}, {x:12,y:4,w:2,h:6}, {x:6,y:5,w:1,h:2,c:"#f00"}, {x:9,y:5,w:1,h:2,c:"#f00"}, {x:0,y:2,w:2,h:8}, {x:14,y:2,w:2,h:8}] }
        };

        const monsters = [
            Object.assign({}, monsterDefs.slime),    // Lv1
            Object.assign({}, monsterDefs.goblin),   // Lv2
            Object.assign({}, monsterDefs.bat),      // Lv3
            Object.assign({}, monsterDefs.wolf),     // Lv4
            Object.assign({}, monsterDefs.orc),      // Lv5
            Object.assign({}, monsterDefs.skeleton), // Lv6
            Object.assign({}, monsterDefs.golem),    // Lv7
            Object.assign({}, monsterDefs.chimera),  // Lv8
            Object.assign({}, monsterDefs.dragon),   // Lv9
            Object.assign({}, monsterDefs.reaper),   // Lv10
            Object.assign({}, monsterDefs.dragon, {id: "red_dragon", name: "„É¨„ÉÉ„Éâ„Éâ„É©„Ç¥„É≥", color: "#ff4444"}), // Lv11
            Object.assign({}, monsterDefs.reaper, {id: "strong_reaper", name: "„Åó„Å´„Åå„Åø(Âº∑)", color: "#9c27b0"}), // Lv12
            Object.assign({}, monsterDefs.demon)     // Lv13
        ];

        const questions = [
            "„Çè„Åü„Åó„ÅØ„ÄÄ„Åã„Åø„Çµ„Éû„Çí„ÄÄ„Åó„Çì„Åò„Çã„ÅãÔºü", "„Åä„Åæ„Åà„ÅØ„ÄÄ„ÇÜ„ÅÜ„Åó„ÇÉ„ÄÄ„Å™„ÅÆ„ÅãÔºü", "„Åì„ÅÆ„Åõ„Åã„ÅÑ„ÅØ„ÄÄ„Åí„Çì„Åò„Å§„ÄÄ„ÅãÔºü",
            "„Éë„É≥„ÅØ„ÄÄ„Åô„Åç„ÅãÔºü", "„ÅÜ„Åó„Çç„Å´„ÄÄ„Å†„Çå„Åã„ÄÄ„ÅÑ„Çã„ÅãÔºü", "„Åò„Åã„Çì„ÅØ„ÄÄ„ÇÄ„Åí„Çì„ÄÄ„ÅãÔºü",
            "„Åä„Å™„Åã„ÅØ„ÄÄ„Åô„ÅÑ„Åü„ÅãÔºü", "„Éú„Çø„É≥„Çí„ÄÄ„Åä„Åô„ÄÄ„Åã„Åè„Åî„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü", "„Åç„Çá„ÅÜ„ÅØ„ÄÄ„ÅÑ„ÅÑ„ÄÄ„Å¶„Çì„Åç„ÅãÔºü",
            "„Åä„Åæ„Åà„Å´„ÄÄ„Å®„ÇÇ„Å†„Å°„ÅØ„ÄÄ„ÅÑ„Çã„ÅãÔºü", "„Åì„ÅÆ„ÄÄ„Åü„Åü„Åã„ÅÑ„ÅØ„ÄÄ„Åü„ÅÆ„Åó„ÅÑ„ÅãÔºü", "„ÅÜ„Åæ„Çå„Åã„Çè„Çä„Åü„ÅÑ„ÅãÔºü",
            "„Åì„Åì„ÅØ„ÄÄ„Åò„Åî„Åè„ÄÄ„ÅãÔºü", "„Åä„Åæ„Åà„ÅÆ„ÄÄ„Å™„Åæ„Åà„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü", "„Åõ„Åã„ÅÑ„Çí„ÄÄ„Åô„Åè„ÅÜ„ÄÄ„Åç„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü",
            "„Åæ„Å†„ÄÄ„ÅÇ„Åç„Çâ„ÇÅ„Å™„ÅÑ„ÄÄ„Å§„ÇÇ„Çä„ÅãÔºü", "„Å≠„ÇÄ„Åè„ÄÄ„Å™„ÅÑ„ÅãÔºü", "„Åæ„Åª„ÅÜ„ÅØ„ÄÄ„Å§„Åã„Åà„Çã„ÅãÔºü",
            "„ÇÑ„Åø„ÅØ„ÄÄ„Åì„Çè„ÅÑ„ÅãÔºü", "„Å≠„Åì„ÅØ„ÄÄ„Åô„Åç„ÅãÔºü", "„Åä„Åã„Å≠„ÅØ„ÄÄ„Åª„Åó„ÅÑ„ÅãÔºü",
            "„Åà„ÅÑ„Åà„Çì„ÅÆ„ÄÄ„ÅÑ„ÅÆ„Å°„ÅØ„ÄÄ„Åª„Åó„ÅÑ„ÅãÔºü", "„Åä„Åæ„Åà„ÅØ„ÄÄ„É≠„Éú„ÉÉ„Éà„ÅãÔºü", "„Åì„Åì„Çç„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü",
            "„ÅÇ„Åó„Åü„ÅØ„ÄÄ„Åè„Çã„Å®„ÄÄ„Åä„ÇÇ„ÅÜ„ÅãÔºü", "„Åã„Åì„Å´„ÄÄ„ÇÇ„Å©„Çä„Åü„ÅÑ„ÅãÔºü", "„ÅÜ„Åù„Çí„ÄÄ„Å§„ÅÑ„Åü„Åì„Å®„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü",
            "„Å≤„Åø„Å§„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü", "„Åü„Åü„Åã„ÅÜ„ÅãÔºü", "„Å´„Åí„Çã„ÅãÔºü",
            "„Å™„Åç„Åù„ÅÜ„Å´„ÄÄ„Å™„Å£„Åü„Åì„Å®„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü", "„Çè„Çâ„Å£„Åü„Åì„Å®„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü", "„Å†„Çå„Åã„Çí„ÄÄ„ÅÇ„ÅÑ„Åó„Å¶„ÅÑ„Çã„ÅãÔºü",
            "„Å≤„Å®„Çä„Åº„Å£„Å°„ÅØ„ÄÄ„Åï„Å≥„Åó„ÅÑ„ÅãÔºü", "„Çà„Çã„ÅØ„ÄÄ„Åè„Çâ„ÅÑ„ÅãÔºü", "„ÅÇ„Åï„ÅØ„ÄÄ„Åæ„Å∂„Åó„ÅÑ„ÅãÔºü",
            "„Åü„ÅÑ„Çà„ÅÜ„ÅØ„ÄÄ„ÅÇ„Å§„ÅÑ„ÅãÔºü", "„Åø„Åö„ÅØ„ÄÄ„Å§„ÇÅ„Åü„ÅÑ„ÅãÔºü", "„ÇÜ„Åç„ÅØ„ÄÄ„Åó„Çç„ÅÑ„ÅãÔºü",
            "„Å®„Çä„ÅØ„ÄÄ„ÅÜ„Åü„ÅÜ„ÅãÔºü", "„Åø„Å°„ÅØ„ÄÄ„Å§„Å•„Åè„ÅãÔºü", "„Ç¥„Éº„É´„ÅØ„ÄÄ„ÅÇ„Çã„ÅãÔºü",
            "„ÅÑ„Åæ„ÅØ„ÄÄ„ÅÑ„Å§„Å†Ôºü", "„Åä„Åæ„Åà„ÅØ„ÄÄ„Å†„Çå„Å†Ôºü", "„É™„É≥„Ç¥„ÅØ„ÄÄ„ÅÇ„Åã„ÅÑ„ÅãÔºü",
            "„Åô„Åπ„Å¶„ÅØ„ÄÄ„ÇÜ„ÇÅ„ÅãÔºü", "„ÇÅ„Çí„ÄÄ„Åï„Åæ„Åó„Åü„ÅÑ„ÅãÔºü", "„Åæ„Å†„ÄÄ„Å≠„Å¶„ÅÑ„Åü„ÅÑ„ÅãÔºü",
            "„Åä„Å™„Åã„Åå„ÄÄ„ÅÑ„Åü„ÅÑ„ÅãÔºü", "„ÅÇ„Åü„Åæ„Åå„ÄÄ„ÅÑ„Åü„ÅÑ„ÅãÔºü", "„Åí„Çì„Åç„ÄÄ„ÅãÔºü",
            "„Å§„Åã„Çå„Åü„ÅãÔºü", "„ÇÑ„Åô„Åø„Åü„ÅÑ„ÅãÔºü", "„ÇÇ„Å£„Å®„ÄÄ„ÅÇ„Åù„Å≥„Åü„ÅÑ„ÅãÔºü",
            "„Åä„Åæ„Åà„ÅØ„ÄÄ„ÅÑ„Åç„Å¶„ÄÄ„ÅÑ„Çã„ÅãÔºü", "„Çè„Åü„Åó„Çí„ÄÄ„Åü„Åä„Åõ„Çã„ÅãÔºü"
        ];

        window.onload = () => {
            loadData();
            updateVisualBtn();
            startLevel(1);
        };

        // --- Auto Mode Control ---
        function toggleAutoMode() {
            isAutoMode = !isAutoMode;
            const btn = document.getElementById('auto-btn');
            
            if(isAutoMode) {
                btn.innerText = "AUTO ON";
                btn.classList.add('active');
                SoundManager.init(); // Ensure audio context on click
                processAutoTurn();
            } else {
                btn.innerText = "AUTO OFF";
                btn.classList.remove('active');
                if(autoTimeout) clearTimeout(autoTimeout);
            }
        }

        // --- Visual Mode Control ---
        function toggleVisualMode() {
            gameSettings.isPixelMode = !gameSettings.isPixelMode;
            updateVisualBtn();
            saveSettings();
            
            if (currentMonster && !document.getElementById('overlay').classList.contains('active')) {
                renderMonsterVisual(currentMonster);
            }
        }

        function updateVisualBtn() {
            const btn = document.getElementById('visual-btn');
            btn.innerText = gameSettings.isPixelMode ? "DOT" : "IMG";
        }

        function processAutoTurn() {
            if(!isAutoMode || isProcessing) return;

            const overlay = document.getElementById('overlay');
            if(overlay.classList.contains('active')) return;

            if(bestRecord.level > 0 && currentLevel === bestRecord.level) {
                isAutoMode = false;
                document.getElementById('auto-btn').innerText = "AUTO OFF";
                document.getElementById('auto-btn').classList.remove('active');
                log("‚òÖ„Éè„Ç§„Çπ„Ç≥„Ç¢„Å®„ÅÜ„Åü„Å§ÔºÅ „Ç™„Éº„Éà„É¢„Éº„Éâ„Çí „Åã„ÅÑ„Åò„Çá„Åó„Åæ„Åó„Åü„ÄÇ", false, 'system');
                return;
            }

            const choice = Math.random() < 0.5 ? 'left' : 'right';
            
            const btnId = choice === 'left' ? 'btn-yes' : 'btn-no';
            const btn = document.getElementById(btnId);
            btn.style.color = '#ffff00';
            setTimeout(() => btn.style.color = '#fff', 100);

            makeChoice(choice);
        }

        // --- Core Game Logic ---

        function startLevel(lvl) {
            currentLevel = lvl;
            determineFate();
            spawnMonster();
            updateUI();
            isProcessing = false;
            
            if(lvl === 1) {
                statsRecord.totalAttempts++;
                saveData(); 
                
                log(`[Lv${lvl}] ${currentMonster.name}„Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`);
                document.getElementById('message-window').innerText = `${currentMonster.name}„Äå${getRandomQuestion()}„Äç`;
                
                if(isAutoMode) {
                    autoTimeout = setTimeout(processAutoTurn, 500);
                }
            }
        }

        function determineFate() {
            const roll = Math.random();
            predeterminedFate = roll < 0.5 ? 'left' : 'right';
            console.log(`[DEBUG] Next Fate: ${predeterminedFate === 'left' ? 'YES' : 'NO'}`);
        }

        function spawnMonster() {
            const idx = currentLevel - 1;
            if (idx < monsters.length) {
                currentMonster = monsters[idx];
            } else {
                currentMonster = monsters[monsters.length - 1];
            }

            renderMonsterVisual(currentMonster);
        }

        function renderMonsterVisual(monster) {
            const container = document.getElementById('monster-visual');
            container.innerHTML = '';
            container.className = ''; 

            if (gameSettings.isPixelMode) {
                container.innerHTML = generateMonsterSVG(monster);
                return;
            }

            const imgPath = `img/${monster.id}.png`;
            const img = document.createElement('img');
            img.src = imgPath;
            img.alt = monster.name;
            
            img.onerror = function() {
                this.remove();
                container.innerHTML = generateMonsterSVG(monster);
            };

            container.appendChild(img);
        }

        function getRandomQuestion() {
            return questions[Math.floor(Math.random() * questions.length)];
        }

        function makeChoice(choice) {
            if(isProcessing) return; 
            isProcessing = true;
            SoundManager.init();

            statsRecord.totalChoices++;
            saveData();

            if (choice === 'left') choiceStats.yes++;
            else choiceStats.no++;
            const isCorrect = (choice === predeterminedFate);
            
            log(`‚ñ∂ ${choice === 'left' ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'}`);

            if (isCorrect) {
                handleSuccess();
            } else {
                handleFailure();
            }
        }

        function handleSuccess() {
            SoundManager.playAttack(); 

            statsRecord.totalSuccesses++;
            saveData();

            const vis = document.getElementById('monster-visual');
            vis.classList.add('anim-damage');
            vis.classList.add('anim-shake');
            
            log(`${currentMonster.name}„Å´ ${playerStats.atk}„ÅÆ „ÉÄ„É°„Éº„Ç∏ÔºÅ`);
            log(`${currentMonster.name}„Çí „Åü„Åä„Åó„ÅüÔºÅ`, false, 'success');

            levelUp();

            const nextDelay = isAutoMode ? 400 : 800; 

            if (currentLevel === 13) {
                statsRecord.totalClears++; 
                saveData();
                setTimeout(() => {
                    showGameClear();
                }, 1000);
            } else {
                setTimeout(() => {
                    currentLevel++;
                    determineFate();
                    spawnMonster();
                    
                    log(`[Lv${currentLevel}] ${currentMonster.name}„Åå „ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`);
                    document.getElementById('message-window').innerText = `${currentMonster.name}„Äå${getRandomQuestion()}„Äç`;
                    updateUI();
                    
                    isProcessing = false;
                    if(isAutoMode) {
                        autoTimeout = setTimeout(processAutoTurn, 400);
                    }
                }, nextDelay);
            }
        }

        function levelUp() {
            const hpUp = Math.floor(Math.random() * 5) + 1;
            const mpUp = Math.floor(Math.random() * 3);
            const atkUp = Math.floor(Math.random() * 2) + 1;

            playerStats.maxHp += hpUp;
            playerStats.hp = playerStats.maxHp; 
            playerStats.maxMp += mpUp;
            playerStats.mp = playerStats.maxMp;
            playerStats.atk += atkUp;

            setTimeout(() => SoundManager.playLevelUp(), 200); 
            log(`„É¨„Éô„É´„Åå„ÅÇ„Åå„Å£„ÅüÔºÅ (HP+${hpUp}, Êîª+${atkUp})`, false, 'levelup');

            if (Math.random() < 0.3) {
                dropItem();
            }
        }

        function dropItem() {
            let itemName = "";
            if (Math.random() < 0.3) {
                // Rare Weapons
                // Logic: higher chance for cool weapons as level increases
                // Use a wider range of the massive list
                const maxIdx = weaponNames.length - 1;
                // tier based on level (max level 13 -> tier around 6-7, but we want full range)
                // Normalize level 1-13 to index 0-90
                const tier = Math.min(maxIdx, Math.floor((currentLevel / 13) * maxIdx));
                const range = 15; // wide variation
                const randIndex = Math.max(0, Math.min(maxIdx, tier - 5 + Math.floor(Math.random() * range)));
                itemName = weaponNames[randIndex];
            } else {
                itemName = itemNames[Math.floor(Math.random() * itemNames.length)];
            }
            playerStats.items.push(itemName);
            log(`${currentMonster.name}„ÅØ ${itemName}„Çí „Åä„Å®„Åó„ÅüÔºÅ`, false, 'item');
        }

        function handleFailure() {
            SoundManager.playDamage(); 

            const vis = document.getElementById('monster-visual');
            vis.classList.add('anim-attack');

            document.getElementById('message-window').innerText = `${currentMonster.name}„ÅÆ „Åì„ÅÜ„Åí„ÅçÔºÅ`;
            log(`„Éü„ÇπÔºÅ „ÇÜ„ÅÜ„Åó„ÇÉ„ÅØ ${playerStats.maxHp}„ÅÆ „ÉÄ„É°„Éº„Ç∏„Çí„ÅÜ„Åë„ÅüÔºÅ`, true);
            playerStats.hp = 0;
            updateUI();

            checkHighScore(); 

            const failDelay = isAutoMode ? 500 : 1000;
            setTimeout(() => {
                showGameOver(false);
            }, failDelay);
        }

        function showGameClear() {
            SoundManager.playClear(); 

            isGameClear = true;
            
            if(isAutoMode) {
                isAutoMode = false;
                document.getElementById('auto-btn').classList.remove('active');
                document.getElementById('auto-btn').innerText = "AUTO OFF";
                log("‚òÖ„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ „Ç™„Éº„Éà„É¢„Éº„Éâ„Çí „Åã„ÅÑ„Åò„Çá„Åó„Åæ„Åó„Åü„ÄÇ", false, 'system');
            }

            const vis = document.getElementById('monster-visual');
            vis.classList.add('anim-clear');
            
            log(`„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ „Åæ„Åä„ÅÜ„Çí „Åü„Åä„Åó„ÅüÔºÅ`, false, 'success');
            
            checkHighScore(); 

            setTimeout(() => {
                showGameOver(true);
            }, 1500);
        }

        function checkHighScore() {
            let isNewRecord = false;
            if (currentLevel > bestRecord.level) {
                isNewRecord = true;
            } else if (currentLevel === bestRecord.level) {
                if (playerStats.items.length > bestRecord.items.length) {
                    isNewRecord = true;
                }
            }
            if (isNewRecord) {
                bestRecord = {
                    level: currentLevel,
                    hp: playerStats.maxHp,
                    mp: playerStats.maxMp,
                    atk: playerStats.atk,
                    items: [...playerStats.items],
                    alias: generateAlias(currentLevel, choiceStats)
                };
                saveData();
                return true;
            }
            return false;
        }

        function showGameOver(isClear) {
            if(!isClear) SoundManager.playGameOver(); 

            const overlay = document.getElementById('overlay');
            const title = document.getElementById('overlay-title');
            const kingMsg = document.getElementById('king-msg'); 
            
            const alias = generateAlias(currentLevel, choiceStats);
            document.getElementById('alias-val').innerText = alias;
            document.getElementById('true-fate-display').innerText = isClear ? "ÈÅãÂëΩ„ÇíË∂ÖË∂ä„Åó„Åü" : (predeterminedFate === 'left' ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà');
            
            // Add to Collections
            addToCollection(playerStats.items, alias);

            if (isClear) {
                overlay.classList.add('clear-mode');
                title.innerText = "GAME CLEAR!!";
                kingMsg.innerText = ""; 
                document.getElementById('true-fate-display').parentElement.style.display = 'none';
            } else {
                overlay.classList.remove('clear-mode');
                title.innerText = "ÂÖ®ÊªÖ„Åó„Åü...";
                kingMsg.innerText = "„Åó„Çì„Åß„Åó„Åæ„ÅÜ„Å®„ÅØ „Å™„Åï„Åë„Å™„ÅÑ..."; 
                document.getElementById('true-fate-display').parentElement.style.display = 'block';
            }

            const isNew = (bestRecord.level === currentLevel && bestRecord.hp === playerStats.maxHp && bestRecord.alias === alias);
            document.getElementById('new-record-badge').style.display = isNew ? 'inline-block' : 'none';

            document.getElementById('res-lvl').innerText = currentLevel;
            document.getElementById('res-hp').innerText = playerStats.maxHp;
            document.getElementById('res-mp').innerText = playerStats.maxMp;
            document.getElementById('res-atk').innerText = playerStats.atk;
            
            document.getElementById('stat-attempts').innerText = statsRecord.totalAttempts;
            document.getElementById('stat-clears').innerText = statsRecord.totalClears;
            document.getElementById('stat-choices').innerText = statsRecord.totalChoices;
            
            let rate = 0;
            if (statsRecord.totalChoices > 0) {
                rate = (statsRecord.totalSuccesses / statsRecord.totalChoices) * 100;
            }
            document.getElementById('stat-rate').innerText = rate.toFixed(1) + "%";
            
            const lootContainer = document.getElementById('loot-list');
            lootContainer.innerHTML = '';
            if (playerStats.items.length === 0) {
                lootContainer.innerHTML = '<div style="color:#888;">„Å™„Åó</div>';
            } else {
                playerStats.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'loot-item';
                    div.innerText = item;
                    lootContainer.appendChild(div);
                });
            }

            overlay.classList.add('active');
            document.querySelector('.choices-container').querySelectorAll('button').forEach(b => b.disabled = true);

            // Auto Retry
            if(isAutoMode && !isGameClear) {
                autoTimeout = setTimeout(() => {
                    resetGame();
                }, 1000);
            }
        }

        function resetGame() {
            currentLevel = 0;
            choiceStats = { yes: 0, no: 0 };
            isGameClear = false;
            
            playerStats = {
                hp: 20, maxHp: 20,
                mp: 5, maxMp: 5,
                atk: 10,
                items: []
            };

            document.getElementById('overlay').classList.remove('active');
            document.getElementById('overlay').classList.remove('clear-mode');
            document.getElementById('log-container').innerHTML = '';
            document.querySelector('.choices-container').querySelectorAll('button').forEach(b => b.disabled = false);
            log("„Åº„ÅÜ„Åë„Çì„ÅÆ „Åç„Çç„Åè„Çí „É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ");
            
            startLevel(1);
        }
        
        function clearData() {
            if(confirm("„Åª„Çì„Å®„ÅÜ„Å´ „Åç„Çç„Åè„Çí „Åô„Åπ„Å¶ „Åë„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Éö„Éº„Ç∏„Åå „É™„É≠„Éº„Éâ „Åï„Çå„Åæ„ÅôÔºâ")) {
                localStorage.removeItem('abyss_rpg_save_v1');
                localStorage.removeItem('abyss_rpg_stats_v1');
                localStorage.removeItem('abyss_rpg_settings_v1'); 
                alert("„Åç„Çç„Åè„ÅØ „Åæ„Å£„Åó„Çá„ÅÜ „Åï„Çå„Åæ„Åó„Åü„ÄÇ");
                location.reload(); 
            }
        }

        function generateMonsterSVG(data) {
            let rects = "";
            data.pixels.forEach(p => {
                const color = p.c ? p.c : data.color;
                rects += `<rect x="${p.x}" y="${p.y}" width="${p.w}" height="${p.h}" fill="${color}" />`;
            });
            return `<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="pixel-art">${rects}</svg>`;
        }

        function log(msg, isFail = false, type = 'normal') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (isFail) entry.classList.add('fail');
            if (type === 'success') entry.classList.add('success');
            if (type === 'item') entry.classList.add('item');
            if (type === 'levelup') entry.classList.add('levelup');
            if (type === 'system') entry.classList.add('system');
            
            entry.innerText = msg;
            container.prepend(entry);
        }

        function updateUI() {
            document.getElementById('level-val').innerText = currentLevel;
            document.getElementById('hp-val').innerText = playerStats.hp;
            document.getElementById('mp-val').innerText = playerStats.mp;
            document.getElementById('atk-val').innerText = playerStats.atk;
            document.getElementById('hs-val-sm').innerText = bestRecord.level;
            
            const prob = Math.pow(2, currentLevel);
            let probStr = prob > 999999999 ? "Ê∏¨ÂÆö‰∏çËÉΩ" : prob.toLocaleString();
            document.getElementById('prob-val').innerText = probStr;
        }

        // --- Expanded Alias System ---
        function generateAlias(lvl, stats) {
            const total = stats.yes + stats.no;
            if (lvl <= 1) return "Áû¨ÊÆ∫„Åï„Çå„ÅóËÄÖ";
            
            const yesRatio = total > 0 ? stats.yes / total : 0;
            
            // Random Prefixes (Massive List)
            const randomPrefixes = [
                "ÁñæÈ¢®„ÅÆ", "ÊÄíÊ∂õ„ÅÆ", "Â•áË∑°„ÅÆ", "‰∏çÂ±à„ÅÆ", "Â≠§È´ò„ÅÆ", "ÊºÜÈªí„ÅÆ", "ÁôΩÈäÄ„ÅÆ", "ÊÑõ„ÅÆ", "ÊÇ≤„Åó„Åø„ÅÆ", 
                "ÈÄ±Êú´„ÅÆ", "ÊîæË™≤Âæå„ÅÆ", "Áï∞‰∏ñÁïå„ÅÆ", "Ëª¢Áîü„Åó„Åü", "ÊúÄÂº∑„ÅÆ", "ÊúÄÂº±„ÅÆ", "ÈÄÜË•≤„ÅÆ", "Ë¶öÈÜí„Åó„Åü",
                "Ëø∑Â≠ê„ÅÆ", "ËÖπ„Éö„Ç≥„ÅÆ", "ÂØù‰∏çË∂≥„ÅÆ", "‰ºùË™¨„ÅÆ", "„ÅÜ„Çè„Åï„ÅÆ", "„Åü„Å†„ÅÆ", "ÊúüÂæÖ„ÅÆ", "Ë¶ãÁøí„ÅÑ", "Ê∞∏ÈÅ†„ÅÆ",
                "Âú∞ÁçÑ„ÅÆ", "Â§©ÂõΩ„ÅÆ", "ËôöÁÑ°„ÅÆ", "Á¥ÑÊùü„ÅÆ", "Âßã„Åæ„Çä„ÅÆ", "ÁµÇ„Çè„Çä„ÅÆ", "ÈáèÁî£Âûã", "È´òÊÄßËÉΩ", "„Éù„É≥„Ç≥„ÉÑ",
                "„Å´„Çè„Åã", "„Ç¨„ÉÅÂã¢", "Ë™≤Èáë", "ÁÑ°Ë™≤Èáë", "„É≠„Ç∞„Ç§„É≥Âã¢", "ÂºïÈÄÄ„Åó„Åü", "Âæ©Â∏∞„Åó„Åü", "Ëá™Áß∞", "ÂÖ¨Ë™ç",
                "ÈÅ∏„Å∞„Çå„Åó", "Âë™„Çè„Çå„Åü", "Á•ùÁ¶è„Åï„Çå„Åü", "Âøò„Çå„Çâ„Çå„Åü", "Âêç„ÇÇ„Å™„Åç", "ÈÄö„Çä„Åô„Åå„Çä„ÅÆ"
            ];
            
            // Random Suffixes (Massive List)
            const randomSuffixes = [
                "ÊóÖ‰∫∫", "Êà¶Â£´", "ÂãáËÄÖ", "È≠îÁéã", "Á•û", "„Éã„Éº„Éà", "Â≠¶Áîü", "Á§æÈï∑", "„Ç¢„Ç§„Éâ„É´", "Áå´", "Áä¨", 
                "„Çπ„É©„Ç§„É†", "„Éâ„É©„Ç¥„É≥", "Ê¶ÇÂøµ", "„Ç∑„Çπ„ÉÜ„É†", "„Éê„Ç∞", "„Éó„É≠„Ç∞„É©„É†", "AI", "„Ç¢„É≥„Éâ„É≠„Ç§„Éâ", "„Çµ„Ç§„Éú„Éº„Ç∞",
                "È≠îÊ≥ï‰Ωø„ÅÑ", "ÂÉß‰æ∂", "ÁõóË≥ä", "Ê≠¶ÈóòÂÆ∂", "Ë≥¢ËÄÖ", "ÈÅä„Å≥‰∫∫", "ÂïÜ‰∫∫", "ÂêüÈÅäË©©‰∫∫", "Ë∏ä„ÇäÂ≠ê", "Êµ∑Ë≥ä",
                "„Çµ„É†„É©„Ç§", "ÂøçËÄÖ", "„Ç¨„É≥„Éä„Éº", "„É©„É≥„Çµ„Éº", "„É©„Ç§„ÉÄ„Éº", "„Éê„Éº„Çµ„Éº„Ç´„Éº", "„Ç≠„É£„Çπ„Çø„Éº", "„Ç¢„Çµ„Ç∑„É≥", "„Çª„Ç§„Éê„Éº", "„Ç¢„Éº„ÉÅ„É£„Éº",
                "Êïë‰∏ñ‰∏ª", "Á†¥Â£äËÄÖ", "ÂâµÈÄ†‰∏ª", "Ë¶≥Ê∏¨ËÄÖ", "ÊîØÈÖçËÄÖ", "Ë∂ÖË∂äËÄÖ", "ÂÆàË≠∑ËÄÖ", "Ë™øÂÅúËÄÖ", "ÂèçÈÄÜËÄÖ", "Âæ©ËÆêËÄÖ",
                "„Åä„Åò„Åï„Çì", "„Åä„Å∞„Åï„Çì", "„ÅäÂÖÑ„Åï„Çì", "„ÅäÂßâ„Åï„Çì", "Â∞ëÂπ¥", "Â∞ëÂ•≥", "Ëµ§„Å°„ÇÉ„Çì", "ËÄÅ‰∫∫", "ÂπΩÈúä", "„Çæ„É≥„Éì"
            ];

            // Deterministic base prefix (Play Style)
            let basePrefix = "";
            if (yesRatio === 1.0) basePrefix = "ÂÖ®ËÇØÂÆö„ÅÆ";
            else if (yesRatio === 0.0) basePrefix = "ÂÖ®Âê¶ÂÆö„ÅÆ";
            else if (yesRatio > 0.8) basePrefix = "„Ç§„Ç®„Çπ„Éû„É≥„Å™";
            else if (yesRatio < 0.2) basePrefix = "Áñë„ÅÑÊ∑±„Åç";
            else if (yesRatio > 0.6) basePrefix = "Á¥†Áõ¥„Å™";
            else if (yesRatio < 0.4) basePrefix = "ÂÅèÂ±à„Å™";
            else if (Math.abs(stats.yes - stats.no) <= 1) basePrefix = "‰∏≠Á´ã„Å™„Çã";
            else basePrefix = "Ê∞ó„Åæ„Åê„Çå„Å™";

            // Determine final prefix
            let prefix = basePrefix;
            // 50% chance to use random flavor prefix instead
            if (Math.random() > 0.5) {
                prefix = randomPrefixes[Math.floor(Math.random() * randomPrefixes.length)];
            }

            // Determine Suffix based on level tier + random
            let suffix = "";
            const tier = Math.floor(lvl / 2); // 0 to 6+
            
            // Create a subset of suffixes appropriate for level
            let suffixPool = [];
            if (tier <= 2) {
                suffixPool = randomSuffixes.slice(0, 15); // Basic jobs/misc
            } else if (tier <= 5) {
                suffixPool = randomSuffixes.slice(15, 40); // Advanced jobs
            } else {
                suffixPool = randomSuffixes.slice(40); // Epic/Godly titles
            }
            
            // Add a chance to pick ANY suffix for chaos
            if(Math.random() < 0.1) suffixPool = randomSuffixes;
            
            suffix = suffixPool[Math.floor(Math.random() * suffixPool.length)];

            // Special Overrides (Fixed Titles for specific feats)
            if (lvl === 13) return "ÈÅãÂëΩ„ÅÆË∂ÖË∂äËÄÖ";
            if (lvl === 7 && yesRatio === 1.0) return "„É©„ÉÉ„Ç≠„Éº„Çª„Éñ„É≥";
            if (lvl > 10 && playerStats.items.includes("„Å≠„Åé")) return "„Å≠„Åé„ÅÆ‰Ωø„ÅÑÊâã";
            if (playerStats.items.length > 8 && lvl < 8) return "Ë≤∑„ÅÑÁâ©‰∏äÊâã";
            if (lvl === 1 && Math.random() < 0.01) return "Âá∫ËêΩ„Å°";

            return prefix + suffix;
        }

        // --- Bestiary / Collection ---
        
        function addToCollection(newItems, newAlias) {
            if(!statsRecord.collectedItems) statsRecord.collectedItems = [];
            if(!statsRecord.collectedAliases) statsRecord.collectedAliases = [];
            
            newItems.forEach(item => {
                if(!statsRecord.collectedItems.includes(item)) {
                    statsRecord.collectedItems.push(item);
                }
            });
            
            if(newAlias && !statsRecord.collectedAliases.includes(newAlias)) {
                statsRecord.collectedAliases.push(newAlias);
            }
            saveData();
        }

        function openBestiary() {
            document.getElementById('bestiary-overlay').classList.add('active');
            switchBestiaryTab('items');
        }

        function closeBestiary() {
            document.getElementById('bestiary-overlay').classList.remove('active');
        }

        function switchBestiaryTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            // Very simple tab switching logic relying on order or text
            if(tab === 'items') tabs[0].classList.add('active');
            else tabs[1].classList.add('active');

            renderBestiaryContent(tab);
        }

        function renderBestiaryContent(tab) {
            const container = document.getElementById('bestiary-content');
            container.innerHTML = '';
            
            const collected = tab === 'items' ? (statsRecord.collectedItems || []) : (statsRecord.collectedAliases || []);
            const allList = tab === 'items' ? allItemsList : collected; // Aliases don't have a fixed "All List" easily, so just show collected
            
            const listEl = document.createElement('div');
            listEl.className = 'collection-list';

            if(tab === 'items') {
                // Show completion rate for items
                const rate = Math.floor((collected.length / allItemsList.length) * 100);
                document.getElementById('collection-rate').innerText = rate + "%";

                allList.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'collection-item';
                    if(collected.includes(item)) {
                        el.innerText = item;
                        el.classList.add('unlocked');
                    } else {
                        el.innerText = "ÔºüÔºüÔºüÔºü";
                    }
                    listEl.appendChild(el);
                });
            } else {
                // Aliases: just list collected
                document.getElementById('collection-rate').innerText = collected.length + "Á®Æ";
                
                // Show most recent first
                [...collected].reverse().forEach(alias => {
                    const el = document.createElement('div');
                    el.className = 'collection-item alias-item unlocked';
                    el.innerText = alias;
                    listEl.appendChild(el);
                });
                if(collected.length === 0) {
                    const el = document.createElement('div');
                    el.className = 'collection-item alias-item';
                    el.innerText = "„Åæ„Å†Áß∞Âè∑„ÇíÁç≤Âæó„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
                    listEl.appendChild(el);
                }
            }
            
            container.appendChild(listEl);
        }

        // --- Settings Management ---
        function saveSettings() {
            localStorage.setItem('abyss_rpg_settings_v1', JSON.stringify(gameSettings));
        }

        function loadSettings() {
            const raw = localStorage.getItem('abyss_rpg_settings_v1');
            if(raw) {
                gameSettings = JSON.parse(raw);
            }
        }

        function saveData() {
            localStorage.setItem('abyss_rpg_save_v1', JSON.stringify(bestRecord));
            localStorage.setItem('abyss_rpg_stats_v1', JSON.stringify(statsRecord));
        }
        
        function loadData() {
            const raw = localStorage.getItem('abyss_rpg_save_v1');
            if(raw) {
                bestRecord = JSON.parse(raw);
            } else {
                bestRecord = { level: 0, items: [], alias: "„Å™„Åó" };
            }
            
            const statsRaw = localStorage.getItem('abyss_rpg_stats_v1');
            if(statsRaw) {
                const loaded = JSON.parse(statsRaw);
                statsRecord = {
                    totalAttempts: loaded.totalAttempts || 0,
                    totalClears: loaded.totalClears || 0,
                    totalChoices: loaded.totalChoices || 0,
                    totalSuccesses: loaded.totalSuccesses || 0,
                    collectedItems: loaded.collectedItems || [],
                    collectedAliases: loaded.collectedAliases || []
                };
            } else {
                statsRecord = { totalAttempts: 0, totalClears: 0, totalChoices: 0, totalSuccesses: 0, collectedItems: [], collectedAliases: [] };
            }
            
            loadSettings(); 
        }
    </script>
</body>
</html>
